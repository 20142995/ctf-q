## RSA_二项式与公约数
https://www.bilibili.com/video/BV1nf4y1M7zG

题目
```python
from uuid import uuid1

from Crypto.Util.number import *
import libnum
import os

flag = f'flag+{uuid1()}'.encode()

p = getPrime(1024)
q = getPrime(1024)
n = p * q
g = n + 1
m = bytes_to_long(flag + os.urandom(80))
assert m < n
c = (pow(g, p, n * n) * pow(m, n, n * n)) % (n * n)
print("c=" + str(c))
print("n=" + str(n))
print("hint=" + str(pow(m, n, n * n)))
print()

# c=229329078576788215014157094223283727102665933434354846271657465481258004693985224717483636648100742716339610912438455791678031656449063481533309570082644167326369487745615645976118434538113313940223719699450212537969401768122064096959406279307841048769067700165879596649293619296603641996075342585507667918619662052070674861601319116736952148871690682548870715083718744274383253007968739514369918870884135898697693908680982334232225880801708096284318314478802529188368393069497191376500694387519055102377282433096804269487145018217488761178322314384696344161349903988256787730897770979369082894385414684309772717630098573240877634569160060028152262153237227955601389124176167152490230851362722481713878970743056662054764635382737752903253466112538152788209290252665572636077706964887132711000549979802043397623367612960299319462751328574120539203443010013340562843271396763659470231819459086969612609417352658212534923697540278892948785667754793970358791789337490559444959334526335147551879223056514790953136059394799464351881989177569250457869769346517110500422167630607326721608360650852360035234968316647348972431290245822339421994339726280117503288834145738164516551435871426848314494441075249228857680778630374784752726258356023
# n=17587609751181553504726079060280153554308234286636883346976304054651821534868191092275898689846751773021935113889739486504997679166043596339725948032409499775677066534338190823687346771793502925093351688502859019393959967974188595686735467872114799118371833139278321634970838064343583635058397559024317549441433264460166964673084022754187901095372940188110172727685642416034611886381241836099473982063653881318226098397733504890151057148178487519594875489806965090620444656983939516786408961235332922476665612532196333395166671466714630216587788974905450686701414067796711818151694361933735061602179777437302436749513
# hint=9918623495278566623753437697794944594212034581082650943075570864345631590538796709433540843011222962322893765514132318684994083164390541091532207477123278298308413813909076758429526423228006320240306243263733234841350026819789752296671715678168732265129992217460642107817401303150929303747326363815248333338222241674177864398483963509475709845248009999326867992700628422695600554014033001004913497400421172791148263929098005229864851917846564020856370030858186780440651259800863615619385568841563801718235453635666136342507142438011906398268314633645372848240980519736442268790893982658285258830361901669218532599356907787517736069142529908273975499870644128706146649573767563468755242797726572344631287545796566243719760399102213884822869842334887005175765584267491787673928124151281156600613263031739520857205991334048017455473299607647012826363039587787700167349353864007693198324143610013930150036963682747320170083026092543852245636144167068180696179608380375098616152314948255293008484495606080146099776358351773188403752453375067884277062693885988742093822900246400454360602723244392509876302998615203773441435557201484464354867740131808566446525773988370792429702546216161961958631450741731044517396608238403424606734264972
```

推导1
$$
\begin{multline}
\shoveleft
\begin{aligned}
& c = (g^p \% n*n) * (m^n\% n*n) \% (n*n) \\
& h = m^n \% (n*n) \\
& 将h代入c \\
& c = (g^p\% nn *h) \% nn
& c = (g^p *h) \% nn
& c = g^p*h+knn \\
& g = n+1 \\
&  \\
& c= (n+1)^p*h + knn \\
& \# 二项式整合 \\
& \# (n+1)^p \\
& \# (n+1)^2 = n^2+2n+1 \\
& \# (n+1)^3 = n^3+ 3n+ 3n^2 + 1 \\
& \# (n+1)^p =  (n^p+kpn+1) = (kpn+1)\\
&  \\
& c = (kpn+1)*h+knn\\
& c = kpnh+h+knn\\
& c = kpnh+h+kpqn\\
& \\
& c-h = kpn\\
& (c-h)//n = kp\\
& p = gcd((c-h)//n, n)\\
& \\
& \\

\end{aligned}
\end{multline}
$$

推导2-逆远法
$$
\begin{multline}
\shoveleft
\begin{aligned}
& c = (g^p \% n*n) * (m^n\% n*n) \% (n*n) \\
& h = m^n \% (n*n) \\
& 将h代入c \\
& c = (g^p\% nn *h) \% nn
& c = (g^p *h) \% nn
& 将h移动到左边,两侧除以h,相当于乘上nn的逆元h1 \\
& c*h1\%(nn) = (g^p) \% nn\\
& g=n+1\\
& \\
& c*h1\%(nn)=((n+1)^p)\%nn\\
& \\
& \# 二项式整合 \\
& \# (n+1)^p \\
& \# (n+1)^2 = n^2+2n+1 \\
& \# (n+1)^3 = n^3+ 3n+ 3n^2 + 1 \\
& \# (n+1)^p =  (n^p+kpn+1) = (kpn+1)\\
&  \\
& c*h1\%nn = (kpn+1)\%nn \\
& (c*h1-1)\%(nn) = (kpn)\%nn \\
&  \\
&  c*h1-1=k_1pn+k_2nn\\
&  c*h1-1=k_1pn+k_2npq\\
&  c*h1-1=kpn\\
&  (c*h1-1) //n = kp\\
&  p=gcd((c*h1-1)//n, n)\\
&  \\
&  \\
& c = kpnh+h+knn\\
& c = kpnh+h+kpqn\\
& \\
& c-h = kpn\\
& (c-h)//n = kp\\
& p = gcd((c-h)//n, n)\\
& \\
& h=m^n\%nn\\
& h=m^n+knn\\
& 同时模n\\
& h\%n = m^n\%n\\
& \\
& phi, n的逆元为d\\
& m=h^d\%n\\
& \\
& \\
& \\
\end{aligned}
\end{multline}
$$

## exp1
```python
import gmpy2
from Crypto.Util.number import long_to_bytes

c=16395681820788977795795649341208086982941100414420076688350337312885969378640850796191642634730805777346665075057384733145806786994136019680142239253343546309801244372941247903799292345139408532833595495426871822160704819355863190128186023359803146315416979505986451262649081435380585359941278235807522351241788443836341977608634937410414063283252945213646076323184206124197725027588468927838161249867199776903565102434976839954105821560631299817424488971179832227078735014194900905940615112585793189121732344181196361780395659030866738523560604705195074798847340063760749280121781137770195686982127869158450363669151051434933542146666258102922245687551899714874682064678843204324244520375302180058792936910380972533973529709637069368784735574333250368950483094461521897266781244393483138686411462567453810751163530227213929145667182786073523039392154387808952535702420554189622129878853127798428448904468702256847814185841354308106761761925694110439281871052284769707263604839720809185173652057246994188541682767822577293154994478083590367319866407206788801351054417950199232087519553417863416690066201732643769325243786559994066938624148227376493445722368726715712824577441708768636817987108741789250043167162704877862075905506116
n=15548841448580775679170321449895028941607561419434156070599299949228686561729689930960166487880955047593574232010069167578955059815587548977982534425617024210854231436613210877534960067679728719746777004157960297885917648286844814232845514552768574257826034884979634718201263902680718830761171858408601270722428879334749253849090038325120539279867302520713903326572102616768052371488904838418963568617906304918010294239702996210935452927655528904730275776427142226961956204273825595524805833095725862127939601616380538175242641424828019172414447760034009775780748930230617630226201361557197076319406745911844883472857
h=198083322697614714537880512084852420000520242555212544658176538235003195513290216183752704674237736134528852716896840098335023249146033555041954915792010576573420269726589584960121837086811180084330652843843442094854779665417500800869004168857903572150169507278216130928514064356866735936991994532832363896900233649786596682045571103636144633485023876796572184113089353355479543524405311450588144345516449659868090576762593734679783494383337979334482049093741208057420218831379675837420009519846217422014198862819671251809764457202652468287413042880896963365241019531921307118252759189168022130510247415181255656434422036439903310569038099956714606620067308789286318124161017365879685484567426142181776406183634386069380347392650161588588250676895752425897555036748262375808963293252679508513123704786597216414345902083722941451248712835167467040253893867500982343618993908142142740186261492771976720774751968403726367584676512590005428829776918397300760345150137403900585502991893077023745679569030013298493083136058298696120490779631263716280912189229515622443403387590758352450995496940444941562794289515148532180309136929188923110592516308184162107869423683023214818607104886698749410329517360665219262760657634529990893049838936

h1 = gmpy2.invert(h, n*n)
p = gmpy2.gcd((h-c) // n, n)
print(p)
q = n//p
assert p*q == n

phi = (p - 1) * (q - 1)
d = gmpy2.invert(n, phi)
m = pow(h, d, n)
print(long_to_bytes(m))

```
## exp2
```python
import gmpy2
from Crypto.Util.number import long_to_bytes

c=16395681820788977795795649341208086982941100414420076688350337312885969378640850796191642634730805777346665075057384733145806786994136019680142239253343546309801244372941247903799292345139408532833595495426871822160704819355863190128186023359803146315416979505986451262649081435380585359941278235807522351241788443836341977608634937410414063283252945213646076323184206124197725027588468927838161249867199776903565102434976839954105821560631299817424488971179832227078735014194900905940615112585793189121732344181196361780395659030866738523560604705195074798847340063760749280121781137770195686982127869158450363669151051434933542146666258102922245687551899714874682064678843204324244520375302180058792936910380972533973529709637069368784735574333250368950483094461521897266781244393483138686411462567453810751163530227213929145667182786073523039392154387808952535702420554189622129878853127798428448904468702256847814185841354308106761761925694110439281871052284769707263604839720809185173652057246994188541682767822577293154994478083590367319866407206788801351054417950199232087519553417863416690066201732643769325243786559994066938624148227376493445722368726715712824577441708768636817987108741789250043167162704877862075905506116
n=15548841448580775679170321449895028941607561419434156070599299949228686561729689930960166487880955047593574232010069167578955059815587548977982534425617024210854231436613210877534960067679728719746777004157960297885917648286844814232845514552768574257826034884979634718201263902680718830761171858408601270722428879334749253849090038325120539279867302520713903326572102616768052371488904838418963568617906304918010294239702996210935452927655528904730275776427142226961956204273825595524805833095725862127939601616380538175242641424828019172414447760034009775780748930230617630226201361557197076319406745911844883472857
h=198083322697614714537880512084852420000520242555212544658176538235003195513290216183752704674237736134528852716896840098335023249146033555041954915792010576573420269726589584960121837086811180084330652843843442094854779665417500800869004168857903572150169507278216130928514064356866735936991994532832363896900233649786596682045571103636144633485023876796572184113089353355479543524405311450588144345516449659868090576762593734679783494383337979334482049093741208057420218831379675837420009519846217422014198862819671251809764457202652468287413042880896963365241019531921307118252759189168022130510247415181255656434422036439903310569038099956714606620067308789286318124161017365879685484567426142181776406183634386069380347392650161588588250676895752425897555036748262375808963293252679508513123704786597216414345902083722941451248712835167467040253893867500982343618993908142142740186261492771976720774751968403726367584676512590005428829776918397300760345150137403900585502991893077023745679569030013298493083136058298696120490779631263716280912189229515622443403387590758352450995496940444941562794289515148532180309136929188923110592516308184162107869423683023214818607104886698749410329517360665219262760657634529990893049838936

h1 = gmpy2.invert(h, n*n)
p = gmpy2.gcd((c*h1-1) // n, n)
print(p)
q = n//p
assert p*q == n

phi = (p - 1) * (q - 1)
d = gmpy2.invert(n, phi)
m = pow(h, d, n)
print(long_to_bytes(m))
```