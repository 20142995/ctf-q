# 题目

```python
from Crypto.Util.number import *
from random import *
from flag import FLAG
# FLAG = b"flag{e382975f-1fe2-4965-afbe-0c9f91d577ad}"

BITS = 1024
flag = bytes_to_long(FLAG)

p = getPrime(BITS)
q = getPrime(BITS)
n = p * q

g = randint(1, n)
a1 = randint(1, n)
a2 = randint(1, n)

k1 = pow(g, a1 * (p - 1), n)
k2 = pow(g, a2 * (p - 1), n)

print("n = %s" % n)
print("k1 = %s" % k1)
print("k2 = %s" % k2)

b1 = randint(1, n)
b2 = randint(1, n)

c1 = (pow(k1,b1,n)*flag)%n
c2 = (pow(k2,b1,n)*flag)%n

assert flag < n

print("c1 = %d" % c1)
print("c2 = %d" % c2)

"""
n = 22429415304281114081321027316355527153130585784527290732617689771124526836636466442685562533062837595691329363170643492052613897899929313563376592341192983133583701272820833804884021394272898821421483144355173703565074827538555230842670696407772655723995141549405462669451317194101691898146943058827727822874072760962964899694207663813753914365597766649283006015033880511967707872919575747575695836539029696680664174873144726953233877816588396785067154135017649428111946426503393384149383271171971651086158074097387172790041583087945812092911687163670029569020565651161167933339441734240244557486245141649392120967213
k1 = 18258613922229249806504306035392759155306734768602093372060871575052038939966040709681823739033529614710241656485761907408109786978875330799042717202885196507344119040611972473330228246175897667886034904723943129178234872673274043135702094609952049091128678845251838440709269592215127963852360382108013140126527193856244773401997333969211930571517845534894290877399884496174748130725057351583740665443084698089826846680181225873102249774811660704033581925032492169830495266765824984471289544564596774346587161852063668077997409294703532787200354731905149024093917924942069647305945154078554123067493698218667640613521
k2 = 4560127002967662909373035869480991662409706801389493738002294129295931756568473792155103491889481985369215638711308290381872965550171944771274227786051669923151306112646977998007896712020741042637711107517151813863721678423152883386819921192651399470286352880224476603003086434975863810803655041703629893457646657114641508284626913009289412217861725553966260073434982160694195177640798132554737768421215904660022749337812208413239951717784357594872722968738278380366014646237032100278768996340024967062602417239800240150459700130493343711604038345352201122774065501931706780954684225079383847390515176639226168503495
c1 = 9282675476646193724318320354313367211430037699625019482388432381245570361139560394083688368232406209205877838158667368632227274441024978384316771042917962710292342919470695174518828484201144889896642917320719701904281558956824269427678449147611930565983897702137654664340497891522785531908180793828753941728071989256769246172443709867038124161006087880497745837129477466250820573623551534200260660028570115270525085195847418956501162054156468861060571490012898941640223316523786670455988468494428407822615141800350487538708544427755565272194154496302853759184171150780667789477313222757504447402940159805813577481927
c2 = 15311990769686941747597622083571952610422782505656893280615527328740825202931524901616434411012372669362612942656630706659052303420653452566059360429048507813134554305166812507658190468358341819879650898920828158388055150202880695156794977700714462085521208424792808325995734942588023935536899001226236399752567615249156142360724091865240855580475066833551269754201823843210027508260616599701866678055803701888699781553617516726844587569698392293046257048485435811290947679203166727236904569382733144233025303304578424262543611804351313435572722988454097825122782251096076604504536602986057621804057758621582200596625
"""
```



# 解题



$$
\begin{aligned}
& \# p是素数 \\
& a^{p-1} \% p = 1 \\
& a^p \  \% \ p = a \% p \\
& \\
& k_1 = g^{a_1*(p-1)} \% n \\
& k_1 = g^{a_1*(p-1)} + kn \\
& 两边同时 \% p \\
& k_1 \% p = g^{a_1*(p-1)} + kn \\
& k_1 \% p = g^{a_1*(p-1)} \% p + kn \% p , kn = k p*q \% p = 0\\
& k_1 \% p = g^{a_1^{p-1}} \% p \\
\\
& \# 费马小定理 \\
& k_1\%p=1 \\
& k_1-1=kp \\
& p = gcd(k_1-1, n) \\
& q = n // p
\end{aligned}
$$

---

$$
\begin{aligned}
& c_1 = (k_1 ^ {b_1} \%n * flag) \ \% \ n \\
& c_1 = (k_1 ^ {b_1} \%n * flag \ \% \ n) \% n  \\
& c_1 = (k_1 ^ {b_1} * flag) \ \% \ n \\
& c_1 = (k_1 ^ {b_1} * flag) \ + kn \\
& \# 同时 \% p \\
& c_1 \% p = (k_1 ^ {b_1} * flag) \% p\\
& c_1 \% p = (k_1 ^ {b_1} \% p  * flag \% p ) \% p\\
& \# k_1 \% p = 1 \\
& c_1 \% p = ((k_1 \% p) ^ {b_1} \% p  * flag \% p ) \% p\\
& c_1 \% p = flag \% p\\
\end{aligned}
$$

# exp

```python
import libnum

n = 22429415304281114081321027316355527153130585784527290732617689771124526836636466442685562533062837595691329363170643492052613897899929313563376592341192983133583701272820833804884021394272898821421483144355173703565074827538555230842670696407772655723995141549405462669451317194101691898146943058827727822874072760962964899694207663813753914365597766649283006015033880511967707872919575747575695836539029696680664174873144726953233877816588396785067154135017649428111946426503393384149383271171971651086158074097387172790041583087945812092911687163670029569020565651161167933339441734240244557486245141649392120967213
k1 = 18258613922229249806504306035392759155306734768602093372060871575052038939966040709681823739033529614710241656485761907408109786978875330799042717202885196507344119040611972473330228246175897667886034904723943129178234872673274043135702094609952049091128678845251838440709269592215127963852360382108013140126527193856244773401997333969211930571517845534894290877399884496174748130725057351583740665443084698089826846680181225873102249774811660704033581925032492169830495266765824984471289544564596774346587161852063668077997409294703532787200354731905149024093917924942069647305945154078554123067493698218667640613521
c1 = 9282675476646193724318320354313367211430037699625019482388432381245570361139560394083688368232406209205877838158667368632227274441024978384316771042917962710292342919470695174518828484201144889896642917320719701904281558956824269427678449147611930565983897702137654664340497891522785531908180793828753941728071989256769246172443709867038124161006087880497745837129477466250820573623551534200260660028570115270525085195847418956501162054156468861060571490012898941640223316523786670455988468494428407822615141800350487538708544427755565272194154496302853759184171150780667789477313222757504447402940159805813577481927

p = libnum.gcd(k1 - 1, n)
print(p)
flag = c1 % p
print(libnum.n2s(flag))
```

